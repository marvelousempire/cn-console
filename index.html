<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CN Console ‚Äî The Briefcase</title>

  <!-- üîí AUTH-FIRST GATE: Hide EVERYTHING until authentication is verified -->
  <style id="auth-gate-styles">
    /* Hide all app content by default - nothing visible until auth check completes */
    body { visibility: hidden !important; opacity: 0 !important; }
    
    /* Only show auth-gate-screen (loading/login) */
    #auth-gate-screen { 
      visibility: visible !important; 
      opacity: 1 !important;
      position: fixed;
      inset: 0;
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--sunday-bg, #0b0c10);
    }
    
    /* Once authenticated, show everything */
    html.authenticated body { visibility: visible !important; opacity: 1 !important; }
    html.authenticated #auth-gate-screen { display: none !important; }
    
    /* Auth page mode - hide chrome, show login */
    html.show-login body { visibility: visible !important; opacity: 1 !important; }
    html.show-login #auth-gate-screen { display: none !important; }
    html.show-login .global-header,
    html.show-login .tabs-container,
    html.show-login .fab-button,
    html.show-login .fab-container,
    html.show-login [class*="fab"],
    html.show-login #global-header-container,
    html.show-login #mainTabs,
    html.show-login .auth-hide {
      display: none !important;
      visibility: hidden !important;
    }
  </style>

  <!-- üé® EARLY THEME DETECTION - Prevents flash of wrong theme -->
  <script>
    (function() {
      // Check all possible theme storage keys (in order of priority)
      var saved = localStorage.getItem('themeMode') || // Current key used by app
                  localStorage.getItem('sunday-theme') || // Legacy key
                  localStorage.getItem('theme'); // Generic fallback

      var theme = saved;
      if (!theme) {
        // Check system preference only if no saved preference
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        theme = prefersDark ? 'dark' : 'light';
      }

      // Apply theme immediately to prevent flash
      if (theme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
      } else {
        // Ensure dark theme is set (remove any light theme attribute)
        document.documentElement.removeAttribute('data-theme');
      }

      console.log('[Theme] Early detection applied:', theme, 'from:', saved ? 'storage' : 'system');
    })();
  </script>

  <!-- üîê INSTANT AUTH CHECK - Before any content loads -->
  <script>
    (function() {
      'use strict';
      
      // Check if user has a token (basic check - full validation happens in boot)
      var token = localStorage.getItem('sunday_access_token');
      var hash = window.location.hash || '';
      var route = hash.replace(/^#\/?/, '').split('?')[0] || '';
      var isLoginRoute = route === 'login' || route === 'register' || 
                         route === 'forgot-password' || route === 'reset-password';
      
      if (token) {
        // Has token - show app (full validation in boot.js)
        document.documentElement.classList.add('authenticated');
      } else if (isLoginRoute) {
        // No token but on login page - show login
        document.documentElement.classList.add('show-login');
      } else {
        // No token, not on login - redirect to login
        if (hash && hash !== '#' && hash !== '#login') {
          sessionStorage.setItem('sunday_redirect_after_login', hash);
        }
        window.location.hash = '#login';
        document.documentElement.classList.add('show-login');
      }
    })();
  </script>

  <!-- üåû Sunday App Framework - Core CSS -->
  <link rel="stylesheet" href="/sundayapp/css/tokens.css">
  <link rel="stylesheet" href="/sundayapp/css/base.css">
  <link rel="stylesheet" href="/sundayapp/css/utilities.css">

  <!-- Sunday Standard primitives (for `sunday-*` classes) -->
  <link rel="stylesheet" href="/sundayapp/css/console-primitives.css">
  <link rel="stylesheet" href="/sundayapp/css/console-shell.css">
  <link rel="stylesheet" href="/sundayapp/css/components/tabs.css">

  <!-- CN Console overrides -->
  <link rel="stylesheet" href="css/ai-console.css?v=20251223a" id="cn-style-core">
  <!-- Style modules (cartridge-like): load/enable page-specific packs when needed -->
  <link rel="stylesheet" href="css/briefcase-library.css?v=20251223a" id="cn-style-briefcase-library" disabled>
  
  <style>
    /* Auth page styles - hide all navigation chrome on login/register pages */
    body.auth-page .global-header,
    body.auth-page .tabs-container,
    body.auth-page .fab-button,
    body.auth-page .fab-container,
    body.auth-page [class*="fab"],
    body.auth-page #global-header-container,
    body.auth-page #mainTabs,
    body.auth-page .auth-hide,
    html.is-auth-page .global-header,
    html.is-auth-page .tabs-container,
    html.is-auth-page .fab-button,
    html.is-auth-page .fab-container,
    html.is-auth-page [class*="fab"],
    html.is-auth-page #global-header-container,
    html.is-auth-page #mainTabs,
    html.is-auth-page .auth-hide {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    body.auth-page #contentContainer,
    html.is-auth-page #contentContainer {
      padding-top: 0 !important;
      margin-top: 0 !important;
    }
  </style>
</head>
<body>
  <!-- üîí AUTH GATE SCREEN - Shows while checking authentication -->
  <div id="auth-gate-screen">
    <div style="text-align: center; color: var(--sunday-text, #e9f3ff);">
      <div style="font-size: 48px; margin-bottom: 16px; animation: pulse 1.5s ease-in-out infinite;">üß©</div>
      <div style="font-size: 18px; font-weight: 600;">CN Console</div>
      <div style="font-size: 14px; opacity: 0.6; margin-top: 8px;">Verifying access...</div>
    </div>
    <style>
      @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
  </div>

  <!-- Auth Page Detection - Hide UI chrome on login/register pages -->
  <script>
    (function() {
      function updateAuthPageUI() {
        const hash = window.location.hash || '';
        const route = hash.replace(/^#\/?/, '').split('?')[0];
        const isAuthPage = route === 'login' || route === 'register' || 
                           route === 'forgot-password' || route === 'reset-password';
        
        document.documentElement.classList.toggle('is-auth-page', isAuthPage);
        document.documentElement.classList.toggle('show-login', isAuthPage && !document.documentElement.classList.contains('authenticated'));
        document.body.classList.toggle('auth-page', isAuthPage);
        
        const elementsToHide = document.querySelectorAll(
          '.global-header, .tabs-container, .fab-button, .fab-container, #global-header-container, #mainTabs, .auth-hide'
        );
        elementsToHide.forEach(el => {
          if (isAuthPage) {
            el.style.cssText = 'display: none !important; visibility: hidden !important;';
          } else {
            el.style.cssText = '';
          }
        });
      }
      
      updateAuthPageUI();
      window.addEventListener('hashchange', updateAuthPageUI);
    })();

    // Tab click handler - use manual loading to avoid Sunday router issues
    async function handleTabClick(event) {
      const target = event.target.closest('a[data-route]');
      if (target) {
        event.preventDefault(); // Prevent default link behavior
        const route = target.getAttribute('data-route');
        console.log('[Tab Click]', route, target.getAttribute('href'));

        try {
          // Always use manual HTML loading to avoid Sunday router script execution issues
          console.log('[Navigation] Using manual HTML loading for reliability');
          await loadPageContent(route, false); // Don't update hash to avoid router triggering

          // Manually update active tab state without triggering hash change
          updateActiveTabForRoute(route);
        } catch (error) {
          console.error('[Navigation] Manual loading failed:', error);
        }
      }
    }

    // Load page content manually when Sunday router isn't available
    async function loadPageContent(route, updateHash = true) {
      try {
        // Get route config (simplified mapping - in real Sunday this comes from config)
        const routeConfigs = {
          'overview': './html/overview.html',
          'contributions': './html/contributions.html',
          'protocols': './html/protocols.html',
          'ai': './html/ai.html',
          'passwords': './html/standalone-passwords.html',
          'consoles': './html/consoles.html',
          'cartridges': './html/cartridges.html',
          'network': './html/network-settings.html',
          'settings': './html/settings.html'
        };

        const contentUrl = routeConfigs[route];
        if (!contentUrl) {
          console.error('[Fallback] No content URL for route:', route);
          return;
        }

        console.log('[Fallback] Loading content from:', contentUrl);

        // Fetch the HTML content
        const response = await fetch(contentUrl);
        if (!response.ok) {
          throw new Error(`Failed to load ${contentUrl}: ${response.status}`);
        }

        const htmlContent = await response.text();
        console.log('[Fallback] Content loaded, length:', htmlContent.length);

        // Insert into content container
        const contentContainer = document.getElementById('contentContainer');
        if (contentContainer) {
          // Clear any existing content and event listeners to prevent conflicts
          contentContainer.innerHTML = '';
          console.log('[Fallback] Content container cleared');

          contentContainer.innerHTML = htmlContent;
          console.log('[Fallback] Content inserted into page');

          // Update URL hash only if requested
          if (updateHash) {
            window.location.hash = '#' + route;
          }

          // Trigger page initialization with defensive checks
          setTimeout(() => {
            try {
              if (window.maybeInitCNPages) {
                window.maybeInitCNPages();
              }
              // Page-specific initialization with error handling
              if (route === 'consoles' && window.initConsolesPage) {
                setTimeout(() => {
                  try {
                    window.initConsolesPage();
                  } catch (e) {
                    console.error('[Fallback] Consoles page init failed:', e);
                  }
                }, 50);
              } else if (route === 'passwords' && window.initPasswordsPage) {
                setTimeout(() => {
                  try {
                    window.initPasswordsPage();
                  } catch (e) {
                    console.error('[Fallback] Passwords page init failed:', e);
                  }
                }, 50);
              }
            } catch (e) {
              console.error('[Fallback] Page initialization failed:', e);
            }
          }, 10);
        } else {
          console.error('[Fallback] Content container not found');
        }

      } catch (error) {
        console.error('[Fallback] Failed to load page content:', error);
        // Show user-friendly error in the content area
        const contentContainer = document.getElementById('contentContainer');
        if (contentContainer) {
          contentContainer.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--muted);">
              <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Failed to load page</div>
              <div>Unable to load the ${route} page. Please try refreshing or contact support.</div>
              <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: var(--brand); color: white; border: none; border-radius: 6px; cursor: pointer;">üîÑ Reload Page</button>
            </div>
          `;
        }
      }
    }

    // Add hash change listener for debugging and tab state updates
    window.addEventListener('hashchange', function() {
      console.log('[Hash Change]', window.location.hash);
      updateActiveTab();
    });

    // Update active tab visual state
    function updateActiveTab() {
      try {
        const hash = window.location.hash || '#';
        const route = hash.replace(/^#\/?/, '').split('?')[0] || 'overview';
        updateActiveTabForRoute(route);
      } catch (error) {
        console.error('[Tab State] Failed to update active tab:', error);
      }
    }

    // Manually update active tab for a specific route
    function updateActiveTabForRoute(route) {
      try {
        // Remove active class from all tabs
        document.querySelectorAll('#mainTabs .tab-btn').forEach(tab => {
          tab.classList.remove('active');
        });

        // Add active class to current tab
        const activeTab = document.querySelector(`#mainTabs .tab-btn[data-route="${route}"]`);
        if (activeTab) {
          activeTab.classList.add('active');
          console.log('[Tab State] Updated active tab to:', route);
        }
      } catch (error) {
        console.error('[Tab State] Failed to update active tab:', error);
      }
    }

    // Initialize active tab on page load
    setTimeout(updateActiveTab, 100);

    // Global error handler to prevent navigation-breaking errors
    window.addEventListener('error', function(event) {
      // Only log errors from our known problematic functions
      if (event.error && event.error.stack &&
          (event.error.stack.includes('updateStats') ||
           event.error.stack.includes('renderConsoles'))) {
        console.error('[Navigation Error] Caught and prevented:', event.error);
        event.preventDefault();
        return false;
      }
    });

    // Also catch unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      if (event.reason && event.reason.message &&
          (event.reason.message.includes('updateStats') ||
           event.reason.message.includes('renderConsoles'))) {
        console.error('[Navigation Error] Caught unhandled rejection:', event.reason);
        event.preventDefault();
      }
    });
  </script>

  <div id="global-header-container" class="global-header auth-hide"></div>

  <div class="tabs-container auth-hide">
    <!-- Pre-render tabs so navigation is visible even if JS fails -->
    <div class="tabs" id="mainTabs" onclick="handleTabClick(event)">
      <a class="tab-btn" href="#overview" data-tab="overview" data-route="overview">
        <span class="tab-icon">üèõÔ∏è</span>
        <span class="tab-label">Overview</span>
      </a>
      <a class="tab-btn" href="#contributions" data-tab="contributions" data-route="contributions">
        <span class="tab-icon">üß©</span>
        <span class="tab-label">Contributions</span>
      </a>
      <a class="tab-btn" href="#protocols" data-tab="protocols" data-route="protocols">
        <span class="tab-icon">üìú</span>
        <span class="tab-label">Protocols</span>
      </a>
      <a class="tab-btn" href="#ai" data-tab="ai" data-route="ai">
        <span class="tab-icon">ü§ñ</span>
        <span class="tab-label">AI</span>
      </a>
      <a class="tab-btn" href="#passwords" data-tab="passwords" data-route="passwords">
        <span class="tab-icon">üîê</span>
        <span class="tab-label">Passwords</span>
      </a>
      <a class="tab-btn" href="#settings" data-tab="settings" data-route="settings">
        <span class="tab-icon">‚öôÔ∏è</span>
        <span class="tab-label">Settings</span>
      </a>
    </div>
  </div>

  <div id="contentContainer" class="content-container">
    <div id="cnBootStatus" class="sunday-card">
      <div class="sunday-card__body">
        <div class="sunday-text sunday-text--title">CN Console ‚Äî The Briefcase</div>
        <div class="sunday-text sunday-text--muted">Loading Contribution Network OS‚Ä¶</div>
      </div>
    </div>
  </div>

  <noscript>
    <div class="sunday-card" style="max-width:720px;margin:24px auto;">
      <div class="sunday-card__header">
        <div class="sunday-text sunday-text--title">JavaScript is disabled</div>
        <div class="sunday-text sunday-text--muted">CN Console requires JavaScript to run.</div>
      </div>
      <div class="sunday-card__body">
        <div class="sunday-text">Enable JavaScript, then reload this page.</div>
      </div>
    </div>
  </noscript>

  <!-- Bootstrap runs as an external module to avoid inline-script blockers -->
  <script type="module" src="./js/cn-boot.js?v=20251223a"></script>
  <script type="module" src="./js/cn-cartridges.js?v=20251223a"></script>

  <script nomodule>
    window.__CN_NO_MODULE = true;
    try {
      const container = document.getElementById('contentContainer');
      if (container) {
        container.innerHTML = `
          <div class="sunday-card" style="max-width:720px;margin:24px auto;">
            <div class="sunday-card__header">
              <div class="sunday-text sunday-text--title">Browser not supported</div>
              <div class="sunday-text sunday-text--muted">This console requires a browser with ES Modules support.</div>
            </div>
            <div class="sunday-card__body">
              <div class="sunday-text">Open this site in the latest Chrome, Firefox, Safari, or Edge.</div>
            </div>
          </div>
        `;
      }
    } catch {}
  </script>

  <!-- If modules are supported but the module failed to load/run, show a clear error. -->
  <script>
    setTimeout(function () {
      try {
        if (window.__CN_BOOT_OK === true) return;
        if (window.__CN_NO_MODULE) return;
        const container = document.getElementById('contentContainer');
        if (!container) return;
        container.innerHTML = `
          <div class="sunday-card" style="max-width:720px;margin:24px auto;">
            <div class="sunday-card__header">
              <div class="sunday-text sunday-text--title">CN Console ‚Äî The Briefcase didn't start</div>
              <div class="sunday-text sunday-text--muted">The browser supports modules, but the boot module did not run.</div>
            </div>
            <div class="sunday-card__body">
              <div class="sunday-text">Try a hard reload. If it persists, check for script blockers/extensions or try another browser.</div>
            </div>
          </div>
        `;
      } catch {}
    }, 2500);
  </script>
</body>
</html>
