<div class="sunday-container" data-cn-page="cartridges">
  <div class="sunday-card" style="margin-bottom: 16px;">
    <div class="sunday-card__header">
      <div>
        <div class="sunday-text sunday-text--title">üì¶ Cartridges</div>
        <div class="sunday-text sunday-text--muted">Modular capability bundles registered in the Contribution Network</div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="sunday-btn" onclick="refreshCartridges()">üîÑ Refresh</button>
        <button class="sunday-btn sunday-btn--secondary" onclick="scanForNewCartridges()">üîç Scan</button>
      </div>
    </div>
  </div>

  <div class="cn-stats-row" id="cartridge-stats">
    <div class="cn-stat-card">
      <div class="cn-stat-value" id="stat-total">-</div>
      <div class="cn-stat-label">Total Cartridges</div>
    </div>
    <div class="cn-stat-card">
      <div class="cn-stat-value" id="stat-active">-</div>
      <div class="cn-stat-label">Active</div>
    </div>
    <div class="cn-stat-card">
      <div class="cn-stat-value" id="stat-consoles">-</div>
      <div class="cn-stat-label">Console Cartridges</div>
    </div>
    <div class="cn-stat-card">
      <div class="cn-stat-value" id="stat-utilities">-</div>
      <div class="cn-stat-label">Utilities</div>
    </div>
  </div>

  <div class="sunday-card">
    <div class="sunday-card__header">
      <div class="sunday-text sunday-text--title">Registered Cartridges</div>
      <span id="cartridge-count" class="cn-badge">Loading...</span>
    </div>
    <div class="sunday-card__body">
      <div id="cartridge-list" class="cn-grid">
        <div class="cn-loading">
          <div class="cn-loading__spinner">‚è≥</div>
          <div class="cn-loading__text">Loading cartridge registry...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cartridge Details Modal -->
  <div id="cartridge-modal" class="cn-modal" style="display: none;">
    <div class="cn-modal__overlay" onclick="closeCartridgeModal()"></div>
    <div class="cn-modal__content">
      <div class="cn-modal__header">
        <h3 id="cartridge-modal-title" class="cn-modal__title">Cartridge Details</h3>
        <button class="cn-modal__close" onclick="closeCartridgeModal()">√ó</button>
      </div>
      <div id="cartridge-modal-body" class="cn-modal__body"></div>
    </div>
  </div>
</div>

<style>
  .cn-stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }
  .cn-stat-card {
    background: var(--card, #fff);
    border: 1px solid var(--line, #e5e7eb);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
  }
  .cn-stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--brand, #8b5cf6);
    line-height: 1;
    margin-bottom: 8px;
  }
  .cn-stat-label {
    font-size: 13px;
    color: var(--muted, #6b7280);
  }

  .cn-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
  }

  .cn-cartridge-card {
    background: var(--card, #fff);
    border: 1px solid var(--line, #e5e7eb);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .cn-cartridge-card:hover {
    border-color: var(--brand, #8b5cf6);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
  }

  .cn-cartridge-header {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .cn-cartridge-icon {
    font-size: 32px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg, #f9fafb);
    border-radius: 10px;
  }
  .cn-cartridge-info h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--ink, #1f2937);
  }
  .cn-cartridge-type {
    font-size: 12px;
    color: var(--muted, #6b7280);
    text-transform: capitalize;
  }

  .cn-cartridge-description {
    font-size: 14px;
    color: var(--muted, #6b7280);
    line-height: 1.5;
    flex: 1;
  }

  .cn-cartridge-meta {
    display: flex;
    gap: 16px;
    font-size: 12px;
  }
  .cn-cartridge-meta-label {
    color: var(--muted, #6b7280);
  }
  .cn-cartridge-meta-value {
    font-weight: 600;
    color: var(--ink, #1f2937);
  }
  .cn-cartridge-status--active { color: #10b981; }
  .cn-cartridge-status--inactive { color: #f59e0b; }

  .cn-cartridge-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }
  .cn-cartridge-actions .sunday-btn {
    flex: 1;
    font-size: 12px;
    padding: 8px 12px;
  }

  .cn-empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted, #6b7280);
  }
  .cn-empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }
  .cn-empty-state-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--ink, #1f2937);
    margin-bottom: 8px;
  }

  .cn-loading {
    text-align: center;
    padding: 40px;
    color: var(--muted, #6b7280);
  }
  .cn-loading__spinner {
    font-size: 32px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .cn-badge {
    background: var(--brand, #8b5cf6);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .cn-modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .cn-modal__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(2px);
  }
  .cn-modal__content {
    position: relative;
    background: var(--card, #fff);
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  .cn-modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    border-bottom: 1px solid var(--line, #e5e7eb);
  }
  .cn-modal__title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
  }
  .cn-modal__close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--muted, #6b7280);
  }
  .cn-modal__body {
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
  }
</style>

<script>
  let cartridgeRegistry = [];

  // Initialize - wait for DOM elements to be ready
  async function initCartridgesPage() {
    // Check if our elements exist
    if (!document.getElementById('cartridge-list')) {
      requestAnimationFrame(initCartridgesPage);
      return;
    }
    await loadCartridgeRegistry();
    renderCartridgeList();
    updateStats();
  }
  
  // Start initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCartridgesPage);
  } else {
    requestAnimationFrame(initCartridgesPage);
  }

  async function loadCartridgeRegistry() {
    try {
      const response = await fetch('/api/cn/contributions');
      if (response.ok) {
        const data = await response.json();
        // Handle both direct array and { contributions: [] } format
        cartridgeRegistry = Array.isArray(data) ? data : (data.contributions || []);
      } else {
        console.warn('Failed to load CN contributions, using fallback');
        cartridgeRegistry = getFallbackCartridges();
      }
    } catch (error) {
      console.error('Error loading cartridge registry:', error);
      cartridgeRegistry = getFallbackCartridges();
    }
  }

  function getFallbackCartridges() {
    // Fallback list of known cartridges
    return [
      { id: 'ai-console', name: 'AI Console', type: 'console', description: 'AI features, Ollama, and model management', active: true, icon: 'ü§ñ' },
      { id: 'quick-actions', name: 'Quick Actions', type: 'cartridge', description: 'FAB-based action menu', active: true, icon: '‚ö°' },
      { id: 'site-manager', name: 'Site Manager', type: 'cartridge', description: 'WordPress site management tools', active: true, icon: 'üåê' },
      { id: 'console-template', name: 'Console Template Wizard', type: 'cartridge', description: 'Create new console templates', active: true, icon: 'üìã' },
      { id: 'clone-wizard', name: 'Clone Wizard', type: 'cartridge', description: 'Site cloning utility', active: true, icon: 'üìÅ' },
      { id: 'dns-manager', name: 'DNS Manager', type: 'cartridge', description: 'Domain and DNS management', active: true, icon: 'üîó' },
    ];
  }

  function updateStats() {
    try {
      // Defensive checks - ensure variables and elements exist
      if (!Array.isArray(cartridgeRegistry)) {
        console.warn('updateStats: cartridgeRegistry not initialized');
        return;
      }

      const total = cartridgeRegistry.length;
      const active = cartridgeRegistry.filter(c => c.active !== false).length;
      const consoles = cartridgeRegistry.filter(c => c.type === 'console' || c.type === 'console-cartridge').length;
      const utilities = cartridgeRegistry.filter(c => c.type === 'cartridge' || c.type === 'utility').length;

      // Safe element updates with existence checks
      const statTotal = document.getElementById('stat-total');
      const statActive = document.getElementById('stat-active');
      const statConsoles = document.getElementById('stat-consoles');
      const statUtilities = document.getElementById('stat-utilities');

      if (statTotal) statTotal.textContent = total;
      if (statActive) statActive.textContent = active;
      if (statConsoles) statConsoles.textContent = consoles;
      if (statUtilities) statUtilities.textContent = utilities;

    } catch (error) {
      console.error('updateStats error:', error);
      // Don't re-throw - allow page to continue functioning
    }
  }

  function renderCartridgeList() {
    const container = document.getElementById('cartridge-list');
    const countEl = document.getElementById('cartridge-count');

    if (!container) return;

    countEl.textContent = `${cartridgeRegistry.length} registered`;

    if (cartridgeRegistry.length === 0) {
      container.innerHTML = `
        <div class="cn-empty-state" style="grid-column: 1 / -1;">
          <div class="cn-empty-state-icon">üì¶</div>
          <div class="cn-empty-state-title">No cartridges found</div>
          <div>Cartridges will appear here once registered in the Contribution Network.</div>
        </div>
      `;
      return;
    }

    container.innerHTML = cartridgeRegistry.map(cartridge => `
      <div class="cn-cartridge-card">
        <div class="cn-cartridge-header">
          <div class="cn-cartridge-icon">${cartridge.icon || getCartridgeIcon(cartridge.type)}</div>
          <div class="cn-cartridge-info">
            <h4>${cartridge.name}</h4>
            <div class="cn-cartridge-type">${cartridge.type}</div>
          </div>
        </div>
        <div class="cn-cartridge-description">
          ${cartridge.description || cartridge.tagline || 'No description available'}
        </div>
        <div class="cn-cartridge-meta">
          <div>
            <span class="cn-cartridge-meta-label">Status: </span>
            <span class="cn-cartridge-status cn-cartridge-status--${cartridge.active !== false ? 'active' : 'inactive'}">
              ${cartridge.active !== false ? 'üü¢ Active' : 'üü° Inactive'}
            </span>
          </div>
        </div>
        <div class="cn-cartridge-actions">
          <button class="sunday-btn" onclick="openCartridge('${cartridge.id}')">üöÄ Open</button>
          <button class="sunday-btn sunday-btn--secondary" onclick="viewCartridgeDetails('${cartridge.id}')">üìã Details</button>
        </div>
      </div>
    `).join('');
  }

  function getCartridgeIcon(type) {
    const icons = {
      'console-cartridge': 'üì¶',
      'console': 'üñ•Ô∏è',
      'cartridge': 'üîß',
      'framework': 'üèóÔ∏è',
      'utility': 'üõ†Ô∏è'
    };
    return icons[type] || 'üì¶';
  }

  function refreshCartridges() {
    const container = document.getElementById('cartridge-list');
    container.innerHTML = `
      <div class="cn-loading" style="grid-column: 1 / -1;">
        <div class="cn-loading__spinner">‚è≥</div>
        <div class="cn-loading__text">Refreshing cartridge registry...</div>
      </div>
    `;
    loadCartridgeRegistry().then(() => {
      renderCartridgeList();
      updateStats();
    });
  }

  function scanForNewCartridges() {
    alert('üîç Scanning for new cartridges in the workspace...\n\nThis feature will scan local directories for unregistered cartridges.');
  }

  function openCartridge(cartridgeId) {
    const cartridge = cartridgeRegistry.find(c => c.id === cartridgeId);
    if (!cartridge) return;

    if (cartridge.type === 'console') {
      window.location.hash = `#${cartridgeId}`;
    } else {
      window.location.hash = `#cartridge/${cartridgeId}`;
    }
  }

  function viewCartridgeDetails(cartridgeId) {
    const cartridge = cartridgeRegistry.find(c => c.id === cartridgeId);
    if (!cartridge) return;

    const modal = document.getElementById('cartridge-modal');
    const title = document.getElementById('cartridge-modal-title');
    const body = document.getElementById('cartridge-modal-body');

    title.textContent = cartridge.name;
    body.innerHTML = `
      <div style="display: grid; gap: 16px;">
        <div><strong>ID:</strong> ${cartridge.id}</div>
        <div><strong>Type:</strong> ${cartridge.type}</div>
        <div><strong>Status:</strong> ${cartridge.active !== false ? 'üü¢ Active' : 'üü° Inactive'}</div>
        <div><strong>Description:</strong> ${cartridge.description || 'No description'}</div>
        ${cartridge.version ? `<div><strong>Version:</strong> ${cartridge.version}</div>` : ''}
        ${cartridge.author ? `<div><strong>Author:</strong> ${cartridge.author}</div>` : ''}
      </div>
    `;

    modal.style.display = 'flex';
  }

  function closeCartridgeModal() {
    document.getElementById('cartridge-modal').style.display = 'none';
  }
</script>
