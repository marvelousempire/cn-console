<div class="sunday-container" data-cn-page="consoles">
  <div class="sunday-card" style="margin-bottom: 16px;">
    <div class="sunday-card__header">
      <div>
        <div class="sunday-text sunday-text--title">üñ•Ô∏è Consoles</div>
        <div class="sunday-text sunday-text--muted">All dashboard surfaces in the Contribution Network</div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="sunday-btn" onclick="refreshConsoles()">üîÑ Refresh</button>
      </div>
    </div>
  </div>

  <!-- Current TLD Indicator -->
  <div class="cn-tld-banner" id="tld-banner">
    <div class="cn-tld-icon">üåê</div>
    <div class="cn-tld-info">
      <div class="cn-tld-label">Current Apex Console</div>
      <div class="cn-tld-value" id="tld-console-name">Loading...</div>
    </div>
    <a href="#network" class="sunday-btn sunday-btn--small">Configure in Network ‚Üí</a>
  </div>

  <!-- Console Grid -->
  <div class="sunday-card" style="margin-top: 20px;">
    <div class="sunday-card__header">
      <div class="sunday-text sunday-text--title">Available Consoles</div>
      <span class="cn-badge" id="console-count">0</span>
    </div>
    <div class="sunday-card__body">
      <div id="console-grid" class="cn-console-grid">
        <div class="cn-loading">
          <div class="cn-loading__spinner">‚è≥</div>
          <div class="cn-loading__text">Loading consoles...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* TLD Banner */
  .cn-tld-banner {
    display: flex;
    align-items: center;
    gap: 16px;
    background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    margin-bottom: 20px;
  }
  .cn-tld-icon {
    font-size: 32px;
  }
  .cn-tld-info {
    flex: 1;
  }
  .cn-tld-label {
    font-size: 12px;
    opacity: 0.8;
    margin-bottom: 4px;
  }
  .cn-tld-value {
    font-size: 18px;
    font-weight: 700;
  }
  .cn-tld-banner .sunday-btn--small {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    font-size: 12px;
    text-decoration: none;
    border-radius: 8px;
  }
  .cn-tld-banner .sunday-btn--small:hover {
    background: rgba(255,255,255,0.3);
  }

  /* Console Grid */
  .cn-console-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }

  .cn-console-card {
    background: var(--card, #fff);
    border: 1px solid var(--line, #e5e7eb);
    border-radius: 14px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    transition: all 0.2s ease;
    position: relative;
  }
  .cn-console-card:hover {
    border-color: var(--brand, #8b5cf6);
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.1);
    transform: translateY(-2px);
  }
  .cn-console-card.is-apex {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(99, 102, 241, 0.08) 100%);
  }
  .cn-console-card.is-apex::after {
    content: 'APEX';
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: #1e1b4b;
    font-size: 9px;
    font-weight: 800;
    padding: 3px 8px;
    border-radius: 5px;
    letter-spacing: 0.5px;
  }
  .cn-console-card.is-current::before {
    content: '';
    position: absolute;
    top: 10px;
    left: 10px;
    width: 8px;
    height: 8px;
    background: #10b981;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
  }

  .cn-console-header {
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .cn-console-icon {
    font-size: 32px;
    width: 52px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg, #f3f4f6);
    border-radius: 12px;
  }
  .cn-console-info h4 {
    margin: 0 0 2px;
    font-size: 16px;
    font-weight: 600;
    color: var(--ink, #1f2937);
  }
  .cn-console-path {
    font-size: 12px;
    color: var(--muted, #6b7280);
    font-family: monospace;
  }

  .cn-console-description {
    font-size: 13px;
    color: var(--muted, #6b7280);
    line-height: 1.45;
    flex: 1;
  }

  .cn-console-actions {
    display: flex;
    gap: 8px;
  }
  .cn-console-actions .sunday-btn {
    flex: 1;
    font-size: 12px;
    padding: 8px 12px;
  }

  .cn-badge {
    background: var(--brand, #8b5cf6);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .cn-loading {
    text-align: center;
    padding: 40px;
    color: var(--muted, #6b7280);
    grid-column: 1 / -1;
  }
  .cn-loading__spinner {
    font-size: 28px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
  let networkData = { tld: '', consoles: {} };
  const currentConsole = 'cn-console';

  // Initialize - wait for DOM elements to be ready
  async function initConsolesPage() {
    // Check if our elements exist
    if (!document.getElementById('console-grid')) {
      requestAnimationFrame(initConsolesPage);
      return;
    }
    await loadNetworkData();
    renderConsoles();
  }
  
  // Start initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initConsolesPage);
  } else {
    // Use setTimeout to ensure DOM is ready for dynamic loading
    setTimeout(initConsolesPage, 10);
  }

  // Also expose init function globally for dynamic loading
  window.initConsolesPage = initConsolesPage;

  async function loadNetworkData() {
    try {
      const response = await fetch('/api/network/tld');
      if (response.ok) {
        networkData = await response.json();
      } else {
        networkData = getFallbackNetworkData();
      }
      
      // Update TLD banner
      const tldConsole = networkData.consoles?.[networkData.tld];
      const tldName = document.getElementById('tld-console-name');
      if (tldName && tldConsole) {
        tldName.textContent = `${tldConsole.icon || 'üñ•Ô∏è'} ${tldConsole.name}`;
      }
    } catch (error) {
      console.error('Error loading network data:', error);
      networkData = getFallbackNetworkData();
    }
  }

  function getFallbackNetworkData() {
    return {
      tld: 'cn-console',
      consoles: {
        'cn-console': { path: '/cn-console', name: 'CN Console', icon: 'üß©', description: 'Contribution Network hub' },
        'quick-server': { path: '/quick-server', name: 'Quick Server', icon: '‚ö°', description: 'Server administration' },
        'ai-console': { path: '/ai-console', name: 'AI Console', icon: 'ü§ñ', description: 'AI features & models' },
        'hive-console': { path: '/hive-console', name: 'Hive Console', icon: 'üêù', description: 'God mode admin' },
        'sunday-console': { path: '/sunday-console', name: 'Sunday Console', icon: 'üåû', description: 'Framework admin' },
        'learnmappers-console': { path: '/learnmappers-console', name: 'LearnMappers', icon: 'üó∫Ô∏è', description: 'Learning platform' },
        'marketplace-console': { path: '/marketplace-console', name: 'Marketplace', icon: 'üõí', description: 'Commerce hub' }
      }
    };
  }

  function renderConsoles() {
    const grid = document.getElementById('console-grid');
    const countEl = document.getElementById('console-count');

    // Defensive check - ensure networkData is loaded
    if (!networkData || !networkData.consoles) {
      console.warn('renderConsoles: networkData not loaded yet, retrying...');
      setTimeout(renderConsoles, 100);
      return;
    }

    const consoles = networkData.consoles || {};
    const consoleIds = Object.keys(consoles);

    countEl.textContent = consoleIds.length;

    if (consoleIds.length === 0) {
      grid.innerHTML = `
        <div class="cn-loading" style="grid-column: 1 / -1;">
          <div style="font-size: 48px; margin-bottom: 16px;">üñ•Ô∏è</div>
          <div style="font-size: 18px; font-weight: 600;">No consoles configured</div>
        </div>
      `;
      return;
    }

    grid.innerHTML = consoleIds.map(id => {
      const c = consoles[id];
      const isApex = id === networkData.tld;
      const isCurrent = id === currentConsole;

      return `
        <div class="cn-console-card ${isApex ? 'is-apex' : ''} ${isCurrent ? 'is-current' : ''}">
          <div class="cn-console-header">
            <div class="cn-console-icon">${c.icon || 'üñ•Ô∏è'}</div>
            <div class="cn-console-info">
              <h4>${c.name}</h4>
              <div class="cn-console-path">${isApex ? '/ (apex)' : c.path}</div>
            </div>
          </div>
          <div class="cn-console-description">${c.description || 'No description'}</div>
          <div class="cn-console-actions">
            <button class="sunday-btn" onclick="openConsole('${id}')">üöÄ Open</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function refreshConsoles() {
    const grid = document.getElementById('console-grid');
    grid.innerHTML = `<div class="cn-loading"><div class="cn-loading__spinner">‚è≥</div></div>`;
    loadNetworkData().then(renderConsoles);
  }

  function openConsole(consoleId) {
    console.log('Opening console:', consoleId);
    console.log('Network data:', networkData);
    console.log('Available consoles:', Object.keys(networkData.consoles || {}));

    const c = networkData.consoles[consoleId];
    if (!c) {
      console.error('Console not found:', consoleId);
      return;
    }

    let url;
    if (consoleId === networkData.tld) {
      // TLD console opens at root
      url = '/';
    } else if (c.tld) {
      // Console has its own domain
      url = `https://${c.tld}`;
    } else if (c.path) {
      // Console is on same domain - construct full URL
      const currentDomain = networkData.domain || window.location.hostname;
      url = `https://${currentDomain}${c.path}`;
    } else {
      console.error('No URL available for console:', consoleId);
      return;
    }

    console.log('Opening URL:', url);

    try {
      const newWindow = window.open(url, '_blank');
      if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
        // Popup blocked or failed to open
        console.warn('Popup blocked, trying same window navigation');
        window.location.href = url;
      }
    } catch (error) {
      console.error('Failed to open window:', error);
      // Fallback to same window navigation
      window.location.href = url;
    }
  }
</script>

