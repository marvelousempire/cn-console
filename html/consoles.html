<div class="sunday-container" data-cn-page="consoles">
  <div class="sunday-card" style="margin-bottom: 16px;">
    <div class="sunday-card__header">
      <div>
        <div class="sunday-text sunday-text--title">üñ•Ô∏è Consoles</div>
        <div class="sunday-text sunday-text--muted">All dashboard surfaces in the Contribution Network</div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="sunday-btn" onclick="refreshConsoles()">üîÑ Refresh</button>
        <button class="sunday-btn sunday-btn--secondary" onclick="checkDNS()">üîç Check DNS</button>
      </div>
    </div>
  </div>

  <!-- Apex Domain Card -->
  <div class="cn-apex-card">
    <div class="cn-apex-header">
      <div class="cn-apex-title">
        <span class="cn-apex-badge">APEX</span>
        <span>Root Domain Configuration</span>
      </div>
      <div class="cn-apex-subtitle">The apex (root) domain is served at the top-level without any path prefix</div>
    </div>

    <div class="cn-apex-body">
      <!-- Domain Input -->
      <div class="cn-apex-domain-row">
        <div class="cn-apex-domain-input-wrap">
          <span class="cn-apex-protocol">https://</span>
          <input type="text" id="apex-domain" class="cn-apex-domain-input" 
                 placeholder="yourdomain.com" 
                 onchange="onDomainChange(this.value)"
                 onkeydown="if(event.key==='Enter') onDomainChange(this.value)">
          <button class="cn-apex-save-btn" onclick="saveDomain()" title="Save Domain">üíæ</button>
        </div>
        <div class="cn-apex-console-select">
          <label>Serves:</label>
          <select id="apex-console-select" onchange="onConsoleChange(this.value)">
            <option value="">Loading...</option>
          </select>
        </div>
      </div>

      <!-- DNS Status Indicators -->
      <div class="cn-dns-status-row">
        <div class="cn-dns-indicator" id="dns-a-status">
          <div class="cn-dns-dot unknown"></div>
          <div class="cn-dns-info">
            <div class="cn-dns-label">A Record</div>
            <div class="cn-dns-value" id="dns-a-value">Checking...</div>
          </div>
        </div>
        <div class="cn-dns-indicator" id="dns-wildcard-status">
          <div class="cn-dns-dot unknown"></div>
          <div class="cn-dns-info">
            <div class="cn-dns-label">Wildcard (*.domain)</div>
            <div class="cn-dns-value" id="dns-wildcard-value">Checking...</div>
          </div>
        </div>
        <div class="cn-dns-indicator" id="dns-ssl-status">
          <div class="cn-dns-dot unknown"></div>
          <div class="cn-dns-info">
            <div class="cn-dns-label">SSL/TLS</div>
            <div class="cn-dns-value" id="dns-ssl-value">Checking...</div>
          </div>
        </div>
      </div>

      <!-- Server IP Info -->
      <div class="cn-server-info">
        <span class="cn-server-label">Server IP:</span>
        <span class="cn-server-value" id="server-ip">Detecting...</span>
        <button class="cn-copy-btn" onclick="copyServerIP()" title="Copy IP">üìã</button>
      </div>
    </div>
  </div>

  <!-- Console Grid -->
  <div class="sunday-card" style="margin-top: 20px;">
    <div class="sunday-card__header">
      <div class="sunday-text sunday-text--title">Available Consoles</div>
      <span class="cn-badge" id="console-count">0</span>
    </div>
    <div class="sunday-card__body">
      <div id="console-grid" class="cn-console-grid">
        <div class="cn-loading">
          <div class="cn-loading__spinner">‚è≥</div>
          <div class="cn-loading__text">Loading consoles...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Apex Domain Card */
  .cn-apex-card {
    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
    border-radius: 16px;
    padding: 24px;
    color: white;
    box-shadow: 0 8px 32px rgba(79, 70, 229, 0.3);
  }
  .cn-apex-header {
    margin-bottom: 20px;
  }
  .cn-apex-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 6px;
  }
  .cn-apex-badge {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: #1e1b4b;
    font-size: 11px;
    font-weight: 800;
    padding: 4px 10px;
    border-radius: 6px;
    letter-spacing: 0.5px;
  }
  .cn-apex-subtitle {
    font-size: 14px;
    opacity: 0.75;
  }

  .cn-apex-body {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .cn-apex-domain-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    align-items: center;
  }
  .cn-apex-domain-input-wrap {
    display: flex;
    align-items: center;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    padding: 4px;
    flex: 1;
    min-width: 280px;
  }
  .cn-apex-protocol {
    padding: 8px 12px;
    font-size: 14px;
    opacity: 0.7;
    font-family: monospace;
  }
  .cn-apex-domain-input {
    flex: 1;
    background: none;
    border: none;
    color: white;
    font-size: 16px;
    font-weight: 600;
    padding: 10px 4px;
    font-family: monospace;
    outline: none;
  }
  .cn-apex-domain-input::placeholder {
    color: rgba(255,255,255,0.4);
  }
  .cn-apex-save-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
  }
  .cn-apex-save-btn:hover {
    background: rgba(255,255,255,0.3);
  }

  .cn-apex-console-select {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .cn-apex-console-select label {
    font-size: 14px;
    opacity: 0.8;
  }
  .cn-apex-console-select select {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 8px;
    color: white;
    padding: 10px 14px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    min-width: 160px;
  }
  .cn-apex-console-select select option {
    background: #312e81;
    color: white;
  }

  /* DNS Status Row */
  .cn-dns-status-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }
  .cn-dns-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.08);
    border-radius: 10px;
    padding: 12px 16px;
    flex: 1;
    min-width: 180px;
  }
  .cn-dns-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .cn-dns-dot.ok { background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5); }
  .cn-dns-dot.error { background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
  .cn-dns-dot.unknown { background: #f59e0b; animation: blink 1.5s infinite; }
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
  .cn-dns-info {
    flex: 1;
  }
  .cn-dns-label {
    font-size: 12px;
    opacity: 0.7;
    margin-bottom: 2px;
  }
  .cn-dns-value {
    font-size: 13px;
    font-weight: 600;
  }

  /* Server Info */
  .cn-server-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    padding: 10px 14px;
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
  }
  .cn-server-label {
    opacity: 0.7;
  }
  .cn-server-value {
    font-family: monospace;
    font-weight: 600;
  }
  .cn-copy-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    opacity: 0.7;
    transition: opacity 0.2s;
  }
  .cn-copy-btn:hover {
    opacity: 1;
  }

  /* Console Grid */
  .cn-console-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }

  .cn-console-card {
    background: var(--card, #fff);
    border: 1px solid var(--line, #e5e7eb);
    border-radius: 14px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    transition: all 0.2s ease;
    position: relative;
  }
  .cn-console-card:hover {
    border-color: var(--brand, #8b5cf6);
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.1);
    transform: translateY(-2px);
  }
  .cn-console-card.is-apex {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(99, 102, 241, 0.08) 100%);
  }
  .cn-console-card.is-apex::after {
    content: 'APEX';
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: #1e1b4b;
    font-size: 9px;
    font-weight: 800;
    padding: 3px 8px;
    border-radius: 5px;
    letter-spacing: 0.5px;
  }
  .cn-console-card.is-current::before {
    content: '';
    position: absolute;
    top: 10px;
    left: 10px;
    width: 8px;
    height: 8px;
    background: #10b981;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
  }

  .cn-console-header {
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .cn-console-icon {
    font-size: 32px;
    width: 52px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg, #f3f4f6);
    border-radius: 12px;
  }
  .cn-console-info h4 {
    margin: 0 0 2px;
    font-size: 16px;
    font-weight: 600;
    color: var(--ink, #1f2937);
  }
  .cn-console-path {
    font-size: 12px;
    color: var(--muted, #6b7280);
    font-family: monospace;
  }

  .cn-console-description {
    font-size: 13px;
    color: var(--muted, #6b7280);
    line-height: 1.45;
    flex: 1;
  }

  .cn-console-actions {
    display: flex;
    gap: 8px;
  }
  .cn-console-actions .sunday-btn {
    flex: 1;
    font-size: 12px;
    padding: 8px 12px;
  }

  .cn-badge {
    background: var(--brand, #8b5cf6);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .cn-loading {
    text-align: center;
    padding: 40px;
    color: var(--muted, #6b7280);
    grid-column: 1 / -1;
  }
  .cn-loading__spinner {
    font-size: 28px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
  let networkData = { tld: '', domain: '', consoles: {} };
  let dnsStatus = { a: 'unknown', wildcard: 'unknown', ssl: 'unknown' };
  const currentConsole = 'cn-console';

  // Initialize
  (async function initConsolesPage() {
    await loadNetworkData();
    await detectServerIP();
    renderConsoles();
    populateConsoleSelect();
    checkDNS();
  })();

  async function loadNetworkData() {
    try {
      const response = await fetch('/api/network/tld');
      if (response.ok) {
        networkData = await response.json();
        // Set domain from current location or network settings
        networkData.domain = networkData.domain || window.location.hostname;
      } else {
        networkData = getFallbackNetworkData();
      }
      
      // Update domain input
      document.getElementById('apex-domain').value = networkData.domain || window.location.hostname;
    } catch (error) {
      console.error('Error loading network data:', error);
      networkData = getFallbackNetworkData();
      document.getElementById('apex-domain').value = window.location.hostname;
    }
  }

  function getFallbackNetworkData() {
    return {
      tld: 'cn-console',
      domain: window.location.hostname,
      available: ['cn-console', 'quick-server', 'ai-console', 'hive-console', 'sunday-console', 'learnmappers-console', 'marketplace-console'],
      consoles: {
        'cn-console': { path: '/cn-console', name: 'CN Console', icon: 'üß©', description: 'Contribution Network hub' },
        'quick-server': { path: '/quick-server', name: 'Quick Server', icon: '‚ö°', description: 'Server administration' },
        'ai-console': { path: '/ai-console', name: 'AI Console', icon: 'ü§ñ', description: 'AI features & models' },
        'hive-console': { path: '/hive-console', name: 'Hive Console', icon: 'üêù', description: 'God mode admin' },
        'sunday-console': { path: '/sunday-console', name: 'Sunday Console', icon: 'üåû', description: 'Framework admin' },
        'learnmappers-console': { path: '/learnmappers-console', name: 'LearnMappers', icon: 'üó∫Ô∏è', description: 'Learning platform' },
        'marketplace-console': { path: '/marketplace-console', name: 'Marketplace', icon: 'üõí', description: 'Commerce hub' }
      }
    };
  }

  async function detectServerIP() {
    try {
      const response = await fetch('/api/network/server-info');
      if (response.ok) {
        const data = await response.json();
        document.getElementById('server-ip').textContent = data.ip || data.publicIP || 'Unknown';
      } else {
        document.getElementById('server-ip').textContent = 'Check failed';
      }
    } catch (error) {
      document.getElementById('server-ip').textContent = 'N/A';
    }
  }

  function populateConsoleSelect() {
    const select = document.getElementById('apex-console-select');
    const consoles = networkData.consoles || {};
    const available = networkData.available || Object.keys(consoles);

    select.innerHTML = available.map(id => {
      const c = consoles[id] || { name: id, icon: 'üñ•Ô∏è' };
      const selected = id === networkData.tld ? 'selected' : '';
      return `<option value="${id}" ${selected}>${c.icon || 'üñ•Ô∏è'} ${c.name}</option>`;
    }).join('');
  }

  async function checkDNS() {
    const domain = document.getElementById('apex-domain').value.trim();
    if (!domain || domain === 'localhost') {
      updateDNSIndicator('a', 'ok', 'Localhost (dev)');
      updateDNSIndicator('wildcard', 'ok', 'N/A (localhost)');
      updateDNSIndicator('ssl', 'unknown', 'No SSL (dev)');
      return;
    }

    // Set to checking
    updateDNSIndicator('a', 'unknown', 'Checking...');
    updateDNSIndicator('wildcard', 'unknown', 'Checking...');
    updateDNSIndicator('ssl', 'unknown', 'Checking...');

    try {
      const response = await fetch('/api/network/dns-check?domain=' + encodeURIComponent(domain));
      if (response.ok) {
        const data = await response.json();
        
        // A Record
        if (data.aRecord?.resolved) {
          updateDNSIndicator('a', 'ok', `‚úì ‚Üí ${data.aRecord.ip}`);
        } else {
          updateDNSIndicator('a', 'error', data.aRecord?.error || 'Not pointing');
        }
        
        // Wildcard
        if (data.wildcard?.resolved) {
          updateDNSIndicator('wildcard', 'ok', `‚úì *.${domain}`);
        } else {
          updateDNSIndicator('wildcard', 'error', data.wildcard?.error || 'Not configured');
        }
        
        // SSL
        if (data.ssl?.valid) {
          updateDNSIndicator('ssl', 'ok', `‚úì Valid (${data.ssl.issuer || 'trusted'})`);
        } else {
          updateDNSIndicator('ssl', data.ssl?.error ? 'error' : 'unknown', data.ssl?.error || 'Unknown');
        }
      } else {
        throw new Error('DNS check failed');
      }
    } catch (error) {
      console.error('DNS check error:', error);
      // Fallback: Try simple connectivity check
      try {
        const testResponse = await fetch(`https://${domain}/`, { mode: 'no-cors', cache: 'no-cache' });
        updateDNSIndicator('a', 'ok', '‚úì Responding');
        updateDNSIndicator('ssl', 'ok', '‚úì HTTPS works');
        updateDNSIndicator('wildcard', 'unknown', 'Check manually');
      } catch (e) {
        updateDNSIndicator('a', 'error', 'Cannot reach');
        updateDNSIndicator('ssl', 'error', 'SSL error');
        updateDNSIndicator('wildcard', 'unknown', 'Unknown');
      }
    }
  }

  function updateDNSIndicator(type, status, text) {
    const indicator = document.getElementById(`dns-${type}-status`);
    const dot = indicator?.querySelector('.cn-dns-dot');
    const value = document.getElementById(`dns-${type}-value`);
    
    if (dot) {
      dot.className = 'cn-dns-dot ' + status;
    }
    if (value) {
      value.textContent = text;
    }
    dnsStatus[type] = status;
  }

  function onDomainChange(value) {
    networkData.domain = value.trim().toLowerCase();
    // Auto-check DNS when domain changes
    checkDNS();
  }

  async function saveDomain() {
    const domain = document.getElementById('apex-domain').value.trim().toLowerCase();
    if (!domain) return;

    try {
      const response = await fetch('/api/network/domain', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ domain })
      });

      if (response.ok) {
        alert('‚úÖ Domain saved: ' + domain);
        checkDNS();
      } else {
        const data = await response.json();
        alert('‚ùå Failed: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      alert('‚ùå Error: ' + error.message);
    }
  }

  async function onConsoleChange(consoleId) {
    if (!consoleId || consoleId === networkData.tld) return;

    try {
      const response = await fetch('/api/network/tld', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ console: consoleId })
      });

      if (response.ok) {
        networkData.tld = consoleId;
        renderConsoles();
      } else {
        const data = await response.json();
        alert('‚ùå Failed: ' + (data.error || 'Unknown error'));
        // Revert select
        document.getElementById('apex-console-select').value = networkData.tld;
      }
    } catch (error) {
      alert('‚ùå Error: ' + error.message);
      document.getElementById('apex-console-select').value = networkData.tld;
    }
  }

  function renderConsoles() {
    const grid = document.getElementById('console-grid');
    const countEl = document.getElementById('console-count');
    const consoles = networkData.consoles || {};
    const consoleIds = Object.keys(consoles);

    countEl.textContent = consoleIds.length;

    if (consoleIds.length === 0) {
      grid.innerHTML = `
        <div class="cn-loading" style="grid-column: 1 / -1;">
          <div style="font-size: 48px; margin-bottom: 16px;">üñ•Ô∏è</div>
          <div style="font-size: 18px; font-weight: 600;">No consoles configured</div>
        </div>
      `;
      return;
    }

    grid.innerHTML = consoleIds.map(id => {
      const c = consoles[id];
      const isApex = id === networkData.tld;
      const isCurrent = id === currentConsole;

      return `
        <div class="cn-console-card ${isApex ? 'is-apex' : ''} ${isCurrent ? 'is-current' : ''}">
          <div class="cn-console-header">
            <div class="cn-console-icon">${c.icon || 'üñ•Ô∏è'}</div>
            <div class="cn-console-info">
              <h4>${c.name}</h4>
              <div class="cn-console-path">${isApex ? '/' : c.path}</div>
            </div>
          </div>
          <div class="cn-console-description">${c.description || 'No description'}</div>
          <div class="cn-console-actions">
            <button class="sunday-btn" onclick="openConsole('${id}')">üöÄ Open</button>
            ${!isApex ? `<button class="sunday-btn sunday-btn--secondary" onclick="setAsApex('${id}')">Set Apex</button>` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  function refreshConsoles() {
    const grid = document.getElementById('console-grid');
    grid.innerHTML = `<div class="cn-loading"><div class="cn-loading__spinner">‚è≥</div></div>`;
    loadNetworkData().then(() => {
      renderConsoles();
      populateConsoleSelect();
      checkDNS();
    });
  }

  function openConsole(consoleId) {
    const c = networkData.consoles[consoleId];
    if (!c) return;
    window.open(consoleId === networkData.tld ? '/' : c.path, '_blank');
  }

  async function setAsApex(consoleId) {
    document.getElementById('apex-console-select').value = consoleId;
    await onConsoleChange(consoleId);
  }

  function copyServerIP() {
    const ip = document.getElementById('server-ip').textContent;
    navigator.clipboard.writeText(ip).then(() => {
      alert('üìã Copied: ' + ip);
    }).catch(() => {
      prompt('Copy this IP:', ip);
    });
  }
</script>

