<div class="sunday-card" style="max-width: 1200px; margin: 0 auto;">
  <div class="sunday-card__header" style="display: flex; align-items: center; justify-content: space-between;">
    <div>
      <div class="sunday-text sunday-text--title">ü§ñ AI Chat</div>
      <div class="sunday-text sunday-text--muted">Chat with NIVRAM.AI - powered by Ollama</div>
    </div>
    <div id="ai-status" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--surface); border-radius: 20px; font-size: 12px;">
      <span id="ai-status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b;"></span>
      <span id="ai-status-text">Checking...</span>
    </div>
  </div>
  
  <div class="sunday-card__body" style="padding: 0;">
    <!-- Chat Messages -->
    <div id="chat-messages" style="height: 400px; overflow-y: auto; padding: 20px; background: var(--bg); display: flex; flex-direction: column; gap: 12px;">
      <div class="ai-message ai-message--system">
        <div class="ai-message__content">
          üëã <strong>Welcome to NIVRAM.AI!</strong><br><br>
          I'm your intelligent assistant. Ask me anything about:<br>
          ‚Ä¢ Server management & DevOps<br>
          ‚Ä¢ Code generation & debugging<br>
          ‚Ä¢ WordPress & Docker<br>
          ‚Ä¢ General knowledge questions
        </div>
      </div>
    </div>
    
    <!-- Chat Input -->
    <div style="padding: 16px; border-top: 1px solid var(--line); background: var(--card);">
      <div style="display: flex; gap: 12px; align-items: flex-end;">
        <textarea 
          id="chat-input" 
          placeholder="Type your message..." 
          rows="2"
          style="flex: 1; padding: 12px; border: 1px solid var(--line); border-radius: 12px; background: var(--surface); color: var(--ink); font-family: inherit; font-size: 14px; resize: none;"
        ></textarea>
        <button 
          id="send-btn" 
          onclick="sendMessage()"
          style="padding: 12px 20px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
        >
          Send ‚Üí
        </button>
      </div>
      <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 12px; color: var(--muted);">
        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
          <input type="checkbox" id="use-context" checked style="accent-color: #8b5cf6;">
          Include context (RAG)
        </label>
        <span>Model: <select id="model-select" style="padding: 4px 8px; border: 1px solid var(--line); border-radius: 6px; background: var(--surface); color: var(--ink); font-size: 12px;">
          <option value="llama3.2">llama3.2</option>
          <option value="mistral">mistral</option>
          <option value="codellama">codellama</option>
        </select></span>
        <button onclick="clearChat()" style="margin-left: auto; padding: 4px 12px; background: var(--surface); border: 1px solid var(--line); border-radius: 6px; color: var(--muted); cursor: pointer; font-size: 12px;">Clear Chat</button>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="sunday-card" style="max-width: 1200px; margin: 24px auto 0;">
  <div class="sunday-card__header">
    <div class="sunday-text sunday-text--title">‚ö° Quick Actions</div>
  </div>
  <div class="sunday-card__body">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
      <button onclick="askQuick('Explain how Docker containers work')" class="quick-action-btn">üê≥ Explain Docker</button>
      <button onclick="askQuick('Write a bash script to backup a directory')" class="quick-action-btn">üíæ Backup Script</button>
      <button onclick="askQuick('What are the best practices for WordPress security?')" class="quick-action-btn">üîí WP Security</button>
      <button onclick="askQuick('Generate a Python function to parse JSON')" class="quick-action-btn">üêç Python JSON Parser</button>
      <button onclick="askQuick('How do I configure NGINX as a reverse proxy?')" class="quick-action-btn">üîÄ NGINX Proxy</button>
      <button onclick="askQuick('Explain Git branching strategies')" class="quick-action-btn">üåø Git Branching</button>
    </div>
  </div>
</div>

<!-- Open AI Console Link -->
<div style="max-width: 1200px; margin: 24px auto; text-align: center;">
  <a href="/ai-console" target="_blank" style="color: var(--accent); text-decoration: none; font-size: 14px;">
    üöÄ Open Full AI Console in New Tab ‚Üí
  </a>
</div>

<style>
.ai-message {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 16px;
  line-height: 1.6;
  font-size: 14px;
}

.ai-message--user {
  align-self: flex-end;
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
  border-bottom-right-radius: 4px;
}

.ai-message--assistant {
  align-self: flex-start;
  background: var(--card);
  border: 1px solid var(--line);
  color: var(--ink);
  border-bottom-left-radius: 4px;
}

.ai-message--system {
  align-self: center;
  background: var(--surface);
  color: var(--muted);
  max-width: 100%;
  text-align: left;
  border: 1px solid var(--line);
}

.ai-message__content {
  white-space: pre-wrap;
  word-break: break-word;
}

.ai-message__content code {
  background: rgba(139, 92, 246, 0.15);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'SF Mono', monospace;
  font-size: 0.9em;
}

.ai-message__content pre {
  background: var(--bg);
  padding: 12px;
  border-radius: 8px;
  overflow-x: auto;
  margin: 8px 0;
}

.quick-action-btn {
  padding: 12px 16px;
  background: var(--surface);
  border: 1px solid var(--line);
  border-radius: 10px;
  color: var(--ink);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.quick-action-btn:hover {
  background: var(--card);
  border-color: #8b5cf6;
  transform: translateY(-1px);
}

.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
  background: var(--card);
  border-radius: 16px;
  width: fit-content;
  border: 1px solid var(--line);
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  background: var(--muted);
  border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
  30% { transform: translateY(-6px); opacity: 1; }
}
</style>

<script>
(function() {
  const messagesContainer = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const statusDot = document.getElementById('ai-status-dot');
  const statusText = document.getElementById('ai-status-text');
  const modelSelect = document.getElementById('model-select');
  const useContext = document.getElementById('use-context');

  // Check AI status
  async function checkStatus() {
    try {
      const res = await fetch('/api/ai/status');
      const data = await res.json();
      if (data.ollama?.available) {
        statusDot.style.background = '#10b981';
        statusText.textContent = 'Connected';
        // Load available models from status response
        if (data.ollama.models && data.ollama.models.length > 0) {
          modelSelect.innerHTML = data.ollama.models.map(m => 
            `<option value="${m}">${m}</option>`
          ).join('');
        }
      } else {
        statusDot.style.background = '#f59e0b';
        statusText.textContent = 'Ollama Offline';
      }
    } catch (e) {
      statusDot.style.background = '#ef4444';
      statusText.textContent = 'Unavailable';
      console.warn('Status check failed:', e);
    }
  }

  // Add message to chat
  function addMessage(content, type) {
    const div = document.createElement('div');
    div.className = `ai-message ai-message--${type}`;
    div.innerHTML = `<div class="ai-message__content">${escapeHtml(content)}</div>`;
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    return div;
  }

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Show typing indicator
  function showTyping() {
    const div = document.createElement('div');
    div.className = 'typing-indicator';
    div.id = 'typing-indicator';
    div.innerHTML = '<span></span><span></span><span></span>';
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Hide typing indicator
  function hideTyping() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) indicator.remove();
  }

  // Send message
  window.sendMessage = async function() {
    const message = chatInput.value.trim();
    if (!message) return;

    // Add user message
    addMessage(message, 'user');
    chatInput.value = '';
    sendBtn.disabled = true;

    // Show typing indicator
    showTyping();

    try {
      const model = modelSelect.value || 'llama3.2';
      const includeContext = useContext.checked;

      const res = await fetch('/api/ai/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message,
          model,
          useRAG: includeContext,
          stream: false
        })
      });

      hideTyping();

      if (!res.ok) {
        const error = await res.json();
        addMessage(`Error: ${error.error || 'Failed to get response'}`, 'system');
        return;
      }

      const data = await res.json();
      if (data.success && data.content) {
        addMessage(data.content, 'assistant');
      } else if (data.error) {
        addMessage(`Error: ${data.error}${data.hint ? ' - ' + data.hint : ''}`, 'system');
      } else {
        addMessage('No response received', 'system');
      }

    } catch (e) {
      hideTyping();
      addMessage(`Error: ${e.message}`, 'system');
    } finally {
      sendBtn.disabled = false;
    }
  };

  // Quick action
  window.askQuick = function(question) {
    chatInput.value = question;
    sendMessage();
  };

  // Clear chat
  window.clearChat = function() {
    messagesContainer.innerHTML = `
      <div class="ai-message ai-message--system">
        <div class="ai-message__content">
          üëã <strong>Chat cleared!</strong> Ask me anything.
        </div>
      </div>
    `;
  };

  // Enter to send
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Check status on load
  checkStatus();
  setInterval(checkStatus, 30000);
})();
</script>
