<div style="padding:20px;max-width:1400px;margin:0 auto">
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
    <span style="font-size:32px">üåê</span>
    <div>
      <h2 style="margin:0">Network Command Center</h2>
      <p style="margin:4px 0 0;color:var(--muted);font-size:13px">
        Monitor and manage all consoles, services, and connections across the network
      </p>
    </div>
    <button class="sunday-btn secondary sm" style="margin-left:auto" onclick="refreshNetworkStatus()">
      üîÑ Refresh
    </button>
  </div>

  <!-- Health Overview -->
  <div class="sunday-card" style="margin-bottom:20px;background:linear-gradient(135deg, var(--card) 0%, color-mix(in srgb, var(--brand) 5%, var(--card)) 100%)">
    <div class="sunday-card__body" style="padding:20px">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:20px;text-align:center">
        <div>
          <div style="font-size:36px;font-weight:800" id="healthyCount">--</div>
          <div style="font-size:11px;color:var(--muted)">Healthy Services</div>
        </div>
        <div>
          <div style="font-size:36px;font-weight:800;color:var(--brand)" id="totalConsoles">--</div>
          <div style="font-size:11px;color:var(--muted)">Total Consoles</div>
        </div>
        <div>
          <div style="font-size:36px;font-weight:800;color:var(--success)" id="pm2Running">--</div>
          <div style="font-size:11px;color:var(--muted)">PM2 Processes</div>
        </div>
        <div>
          <div style="font-size:36px;font-weight:800;color:var(--accent)" id="activePorts">--</div>
          <div style="font-size:11px;color:var(--muted)">Active Ports</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Apex Domain Configuration -->
  <div class="apex-config-card" style="margin-bottom:20px">
    <div class="apex-header">
      <div class="apex-title">
        <span class="apex-badge">APEX</span>
        <span>Root Domain Configuration</span>
      </div>
      <div class="apex-subtitle">The apex (root) domain served at the top-level without any path prefix</div>
    </div>

    <div class="apex-body">
      <!-- Domain Input -->
      <div class="apex-domain-row">
        <div class="apex-domain-input-wrap">
          <span class="apex-protocol">https://</span>
          <input type="text" id="apex-domain" class="apex-domain-input" 
                 placeholder="yourdomain.com" 
                 onchange="onDomainChange(this.value)"
                 onkeydown="if(event.key==='Enter') checkDNS()">
          <button class="apex-save-btn" onclick="saveDomain()" title="Save Domain">üíæ</button>
        </div>
        <div class="apex-console-select">
          <label>Serves:</label>
          <select id="apex-console-select" onchange="onConsoleChange(this.value)">
            <option value="">Loading...</option>
          </select>
        </div>
        <button class="sunday-btn secondary sm" onclick="checkDNS()">üîç Check DNS</button>
      </div>

      <!-- DNS Status Indicators -->
      <div class="dns-status-row">
        <div class="dns-indicator" id="dns-a-status">
          <div class="dns-dot unknown"></div>
          <div class="dns-info">
            <div class="dns-label">A Record (@)</div>
            <div class="dns-value" id="dns-a-value">Checking...</div>
            <div class="dns-detail" id="dns-a-detail" style="font-size:10px;opacity:0.7;margin-top:2px"></div>
          </div>
        </div>
        <div class="dns-indicator" id="dns-wildcard-status">
          <div class="dns-dot unknown"></div>
          <div class="dns-info">
            <div class="dns-label">Wildcard (*)</div>
            <div class="dns-value" id="dns-wildcard-value">Checking...</div>
            <div class="dns-detail" id="dns-wildcard-detail" style="font-size:10px;opacity:0.7;margin-top:2px"></div>
          </div>
        </div>
        <div class="dns-indicator" id="dns-ssl-status">
          <div class="dns-dot unknown"></div>
          <div class="dns-info">
            <div class="dns-label">SSL/TLS</div>
            <div class="dns-value" id="dns-ssl-value">Checking...</div>
            <div class="dns-detail" id="dns-ssl-detail" style="font-size:10px;opacity:0.7;margin-top:2px"></div>
          </div>
        </div>
      </div>

      <!-- Server & Registrar Info -->
      <div class="dns-info-row">
        <div class="dns-info-item">
          <span class="dns-info-label">üñ•Ô∏è Server IP:</span>
          <span class="dns-info-value" id="server-ip">Detecting...</span>
          <button class="copy-btn" onclick="copyServerIP()" title="Copy IP">üìã</button>
        </div>
        <div class="dns-info-item">
          <span class="dns-info-label">üè¢ DNS Provider:</span>
          <span class="dns-info-value" id="dns-registrar">Checking...</span>
        </div>
        <div class="dns-info-item" id="dns-nameservers-row" style="display:none">
          <span class="dns-info-label">üì° Nameservers:</span>
          <span class="dns-info-value" id="dns-nameservers" style="font-size:11px">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Subdomain Checker -->
  <div class="sunday-card" style="margin-bottom:20px">
    <div class="sunday-card__header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div>
        <h3 style="margin:0">üîó Subdomain Records</h3>
        <p style="margin:4px 0 0;color:var(--muted);font-size:12px">
          Console subdomains auto-checked ‚Ä¢ Add custom subdomains to test
        </p>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="sunday-btn secondary sm" onclick="loadConsoleSubdomains()">üîÑ Refresh</button>
        <button class="sunday-btn secondary sm" onclick="scanCommonSubdomains()">üîç Scan Common</button>
        <button class="sunday-btn ghost sm" onclick="clearSubdomains()">üóëÔ∏è Clear</button>
      </div>
    </div>
    <div class="sunday-card__body">
      <!-- Console Subdomain Presets -->
      <div style="margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px">
          <div style="font-weight:700">‚öôÔ∏è Console Subdomain Presets</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="sunday-btn secondary sm" onclick="saveAllConsolePresets()">üíæ Save All</button>
          </div>
        </div>
        <div id="console-presets" class="subdomain-grid">
          <div class="subdomain-empty">
            <span>‚öôÔ∏è</span>
            <span>Loading console presets‚Ä¶</span>
          </div>
        </div>
      </div>

      <!-- Subdomain Input -->
      <div class="subdomain-input-row">
        <input type="text" id="subdomain-input" class="subdomain-input" 
               placeholder="Enter subdomain (e.g., api, www, cdn)"
               onkeydown="if(event.key==='Enter') checkSubdomain()">
        <button class="sunday-btn primary sm" onclick="checkSubdomain()">Check</button>
      </div>
      
      <!-- Subdomain Results -->
      <div id="subdomain-results" class="subdomain-grid">
        <div class="subdomain-empty">
          <span>üîó</span>
          <span>Enter a subdomain above or click "Scan Common" to check multiple</span>
        </div>
      </div>
    </div>
  </div>

  <!-- TLD Console Selector Grid -->
  <div class="sunday-card" style="margin-bottom:20px">
    <div class="sunday-card__header" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3 style="margin:0">üè† Select Apex Console</h3>
        <p style="margin:4px 0 0;color:var(--muted);font-size:12px">
          Click to set which console serves at the root domain
        </p>
      </div>
      <span id="tldBadge" class="sunday-badge" style="background:var(--brand);color:white;padding:4px 12px;border-radius:20px;font-size:12px">
        Loading...
      </span>
    </div>
    <div class="sunday-card__body">
      <div class="console-grid" id="consoleGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px">
        <!-- Console options will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Console Status Grid -->
  <div class="sunday-card" style="margin-bottom:20px">
    <div class="sunday-card__header">
      <h3 style="margin:0">üìä Console Status</h3>
    </div>
    <div class="sunday-card__body" style="padding:0">
      <div id="consoleStatusGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1px;background:var(--line)">
        <!-- Console status cards will be loaded here -->
      </div>
    </div>
  </div>

  <!-- PM2 Processes -->
  <div class="sunday-card" style="margin-bottom:20px">
    <div class="sunday-card__header">
      <h3 style="margin:0">‚öôÔ∏è PM2 Processes</h3>
    </div>
    <div class="sunday-card__body" style="padding:0;overflow-x:auto">
      <table style="width:100%;border-collapse:collapse;font-size:13px" id="pm2Table">
        <thead>
          <tr style="background:var(--bg)">
            <th style="padding:12px 16px;text-align:left;font-weight:600">Name</th>
            <th style="padding:12px 16px;text-align:left;font-weight:600">Status</th>
            <th style="padding:12px 16px;text-align:left;font-weight:600">PID</th>
            <th style="padding:12px 16px;text-align:left;font-weight:600">Memory</th>
            <th style="padding:12px 16px;text-align:left;font-weight:600">CPU</th>
            <th style="padding:12px 16px;text-align:left;font-weight:600">Restarts</th>
            <th style="padding:12px 16px;text-align:left;font-weight:600">Actions</th>
          </tr>
        </thead>
        <tbody id="pm2TableBody">
          <tr><td colspan="7" style="padding:20px;text-align:center;color:var(--muted)">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Active Ports -->
  <div class="sunday-card" style="margin-bottom:20px">
    <div class="sunday-card__header">
      <h3 style="margin:0">üîå Active Ports</h3>
    </div>
    <div class="sunday-card__body">
      <div id="portsGrid" style="display:flex;flex-wrap:wrap;gap:8px">
        <!-- Port badges will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Traefik Routes -->
  <div class="sunday-card">
    <div class="sunday-card__header">
      <h3 style="margin:0">üö¶ Traefik Routes</h3>
    </div>
    <div class="sunday-card__body">
      <div id="traefikRoutes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px">
        <!-- Traefik routes will be loaded here -->
      </div>
    </div>
  </div>
</div>

<style>
  /* Apex Domain Card */
  .apex-config-card {
    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
    border-radius: 16px;
    padding: 24px;
    color: white;
    box-shadow: 0 8px 32px rgba(79, 70, 229, 0.3);
  }
  .apex-header { margin-bottom: 20px; }
  .apex-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 6px;
  }
  .apex-badge {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: #1e1b4b;
    font-size: 11px;
    font-weight: 800;
    padding: 4px 10px;
    border-radius: 6px;
    letter-spacing: 0.5px;
  }
  .apex-subtitle {
    font-size: 14px;
    opacity: 0.75;
  }
  .apex-body {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .apex-domain-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    align-items: center;
  }
  .apex-domain-input-wrap {
    display: flex;
    align-items: center;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    padding: 4px;
    flex: 1;
    min-width: 280px;
  }
  .apex-protocol {
    padding: 8px 12px;
    font-size: 14px;
    opacity: 0.7;
    font-family: monospace;
  }
  .apex-domain-input {
    flex: 1;
    background: none;
    border: none;
    color: white;
    font-size: 16px;
    font-weight: 600;
    padding: 10px 4px;
    font-family: monospace;
    outline: none;
  }
  .apex-domain-input::placeholder { color: rgba(255,255,255,0.4); }
  .apex-save-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
  }
  .apex-save-btn:hover { background: rgba(255,255,255,0.3); }
  .apex-console-select {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .apex-console-select label {
    font-size: 14px;
    opacity: 0.8;
  }
  .apex-console-select select {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 8px;
    color: white;
    padding: 10px 14px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    min-width: 160px;
  }
  .apex-console-select select option {
    background: #312e81;
    color: white;
  }

  /* DNS Status Row */
  .dns-status-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }
  .dns-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.08);
    border-radius: 10px;
    padding: 12px 16px;
    flex: 1;
    min-width: 180px;
  }
  .dns-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .dns-dot.ok { background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5); }
  .dns-dot.error { background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
  .dns-dot.unknown { background: #f59e0b; animation: blink 1.5s infinite; }
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
  .dns-info { flex: 1; }
  .dns-label {
    font-size: 12px;
    opacity: 0.7;
    margin-bottom: 2px;
  }
  .dns-value {
    font-size: 13px;
    font-weight: 600;
  }
  .dns-info-row {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    padding: 12px 16px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
  }
  .dns-info-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
  }
  .dns-info-label { opacity: 0.7; }
  .dns-info-value { font-family: monospace; font-weight: 600; }
  .copy-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    opacity: 0.7;
    transition: opacity 0.2s;
  }
  .copy-btn:hover { opacity: 1; }

  /* Subdomain Checker */
  .subdomain-input-row {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
  }
  .subdomain-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--line);
    border-radius: 8px;
    background: var(--bg);
    color: var(--ink);
    font-size: 14px;
  }
  .subdomain-input:focus {
    outline: none;
    border-color: var(--brand);
  }
  .subdomain-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
  }
  .subdomain-card {
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 14px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .subdomain-card.resolved {
    border-color: var(--success);
    background: color-mix(in srgb, var(--success) 5%, var(--bg));
  }
  .subdomain-card.unresolved {
    border-color: var(--line);
    opacity: 0.6;
  }
  .subdomain-card.is-console {
    border-color: var(--accent);
    background: color-mix(in srgb, var(--accent) 5%, var(--bg));
  }
  .subdomain-card.is-console.resolved {
    border-color: var(--success);
    background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 5%, var(--bg)), color-mix(in srgb, var(--success) 8%, var(--bg)));
  }
  .subdomain-icon {
    font-size: 24px;
    flex-shrink: 0;
  }
  .subdomain-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .subdomain-dot.ok { background: var(--success); }
  .subdomain-dot.error { background: var(--error); }
  .subdomain-dot.checking { background: var(--warning); animation: blink 1s infinite; }
  .subdomain-info { flex: 1; min-width: 0; }
  .subdomain-name {
    font-weight: 600;
    font-size: 13px;
    color: var(--ink);
    margin-bottom: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .subdomain-badge {
    font-size: 10px;
    font-weight: 500;
    background: var(--accent);
    color: #fff;
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
  }
  .subdomain-url {
    font-size: 11px;
    color: var(--muted);
    font-family: 'SF Mono', Monaco, monospace;
    margin-bottom: 3px;
  }
  .subdomain-value {
    font-size: 11px;
    color: var(--muted);
    font-family: monospace;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .subdomain-type {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    background: var(--line);
    color: var(--muted);
    font-weight: 600;
  }
  .subdomain-empty {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
  .subdomain-empty span:first-child {
    font-size: 32px;
    opacity: 0.5;
  }

  .console-option {
    padding: 12px;
    background: var(--bg);
    border: 2px solid var(--line);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
  }
  .console-option:hover {
    border-color: var(--brand);
    transform: translateY(-2px);
  }
  .console-option.selected {
    border-color: var(--brand);
    background: color-mix(in srgb, var(--brand) 10%, transparent);
  }
  .console-option .icon { font-size: 24px; margin-bottom: 6px; }
  .console-option .name { font-weight: 600; font-size: 12px; }
  
  .console-status-card {
    padding: 16px;
    background: var(--card);
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .console-status-card .icon { font-size: 28px; }
  .console-status-card .info { flex: 1; }
  .console-status-card .name { font-weight: 600; font-size: 14px; }
  .console-status-card .path { font-size: 11px; color: var(--muted); font-family: monospace; }
  .console-status-card .status-dot {
    width: 10px; height: 10px; border-radius: 50%;
  }
  .console-status-card .status-dot.healthy { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .console-status-card .status-dot.unhealthy { background: var(--error); }
  
  .port-badge {
    padding: 6px 12px;
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 6px;
    font-family: monospace;
    font-size: 12px;
  }
  .port-badge.important { border-color: var(--brand); background: color-mix(in srgb, var(--brand) 10%, transparent); }
  
  .traefik-route {
    padding: 12px;
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 8px;
  }
  .traefik-route .host { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
  .traefik-route .name { font-size: 11px; color: var(--muted); }
</style>

<script>
  // IMPORTANT: this page can be loaded multiple times by the Sunday router.
  // Avoid top-level `let`/`const` which will throw "Identifier has already been declared".
  var networkData = null;
  var currentTld = null;
  var currentDomain = null;
  var tldDataCache = null;
  var dnsStatus = { a: 'unknown', wildcard: 'unknown', ssl: 'unknown' };

  function isNetworkPageMounted() {
    // If this element is gone, the user navigated away and this page is no longer mounted.
    return !!document.getElementById('healthyCount');
  }

  async function refreshNetworkStatus() {
    // Prevent background timers / async work from crashing the shell after navigation away.
    if (!isNetworkPageMounted()) return;

    try {
      // Get network status
      const statusRes = await fetch('/api/network-status/status');
      networkData = await statusRes.json();
      
      if (!networkData.success) throw new Error(networkData.error);
      
      // Get TLD info
      const tldRes = await fetch('/api/network/tld');
      const tldData = await tldRes.json();
      tldDataCache = tldData;
      currentTld = tldData.tld;
      currentDomain = tldData.domain || window.location.hostname;
      
      // Update domain input
      const apexInput = document.getElementById('apex-domain');
      if (apexInput) apexInput.value = currentDomain;
      
      // Populate console select
      populateConsoleSelect(tldData.consoles, tldData.available);

      // Load console subdomain presets from network-master.json
      applyConsolePresetsFromNetwork(tldData.consoles);
      
      // Get server IP
      await detectServerIP();
      
      // Check DNS
      await checkDNS();
      
      // Load console subdomains automatically
      await loadConsoleSubdomains();
      
      renderDashboard();
    } catch (err) {
      console.error('Failed to load network status:', err);
    }
  }
  
  function populateConsoleSelect(consoles, available) {
    const select = document.getElementById('apex-console-select');
    if (!select) return;
    const options = available || Object.keys(consoles || {});
    
    select.innerHTML = options.map(id => {
      const c = consoles?.[id] || { name: id, icon: 'üñ•Ô∏è' };
      const selected = id === currentTld ? 'selected' : '';
      return `<option value="${id}" ${selected}>${c.icon || 'üñ•Ô∏è'} ${c.name}</option>`;
    }).join('');
  }
  
  async function detectServerIP() {
    try {
      const response = await fetch('/api/network/server-info');
      if (response.ok) {
        const data = await response.json();
        document.getElementById('server-ip').textContent = data.ip || data.publicIP || 'Unknown';
      } else {
        document.getElementById('server-ip').textContent = 'Check failed';
      }
    } catch (error) {
      document.getElementById('server-ip').textContent = 'N/A';
    }
  }
  
  async function checkDNS() {
    const domain = document.getElementById('apex-domain').value.trim();
    if (!domain || domain === 'localhost') {
      updateDNSIndicator('a', 'ok', 'Localhost (dev)');
      updateDNSIndicator('wildcard', 'ok', 'N/A (localhost)');
      updateDNSIndicator('ssl', 'unknown', 'No SSL (dev)');
      document.getElementById('dns-registrar').textContent = 'Local';
      return;
    }

    // Set to checking
    updateDNSIndicator('a', 'unknown', 'Checking...');
    updateDNSIndicator('wildcard', 'unknown', 'Checking...');
    updateDNSIndicator('ssl', 'unknown', 'Checking...');
    document.getElementById('dns-registrar').textContent = 'Checking...';

    try {
      const response = await fetch('/api/network/dns-check?domain=' + encodeURIComponent(domain));
      if (response.ok) {
        const data = await response.json();
        
        // A Record
        const aDetail = document.getElementById('dns-a-detail');
        if (data.aRecord?.resolved) {
          updateDNSIndicator('a', 'ok', `‚úì POINTING`);
          if (aDetail) aDetail.textContent = `@ ‚Üí ${data.aRecord.ip}`;
          document.getElementById('server-ip').textContent = data.aRecord.ip;
        } else {
          updateDNSIndicator('a', 'error', `‚úó NOT POINTING`);
          if (aDetail) aDetail.textContent = 'Domain not resolving to server';
        }
        
        // Wildcard - show explicit status
        const wildcardDetail = document.getElementById('dns-wildcard-detail');
        if (data.wildcard?.resolved) {
          if (data.wildcard.type === 'CNAME') {
            updateDNSIndicator('wildcard', 'ok', `‚úì CONFIGURED`);
            if (wildcardDetail) wildcardDetail.textContent = `*.${domain} ‚Üí ${data.wildcard.target}`;
          } else {
            updateDNSIndicator('wildcard', 'ok', `‚úì CONFIGURED`);
            if (wildcardDetail) wildcardDetail.textContent = `*.${domain} ‚Üí ${data.wildcard.ip}`;
          }
        } else {
          updateDNSIndicator('wildcard', 'error', `‚úó NOT CONFIGURED`);
          if (wildcardDetail) wildcardDetail.textContent = data.wildcard?.error || 'Add a * record in your DNS';
        }
        
        // SSL
        const sslDetail = document.getElementById('dns-ssl-detail');
        if (data.ssl?.valid) {
          updateDNSIndicator('ssl', 'ok', `‚úì SECURE`);
          if (sslDetail) sslDetail.textContent = `Issued by ${data.ssl.issuer || 'Unknown'}`;
        } else {
          updateDNSIndicator('ssl', 'error', `‚úó NO SSL`);
          if (sslDetail) sslDetail.textContent = data.ssl?.error || 'Certificate missing or invalid';
        }
        
        // Registrar/DNS Provider
        if (data.registrar?.name) {
          document.getElementById('dns-registrar').textContent = data.registrar.name;
        } else {
          document.getElementById('dns-registrar').textContent = 'Unknown';
        }
        
        // Nameservers
        if (data.registrar?.nameservers?.length) {
          document.getElementById('dns-nameservers').textContent = data.registrar.nameservers.slice(0, 2).join(', ');
          document.getElementById('dns-nameservers-row').style.display = 'flex';
        }
      }
    } catch (error) {
      console.error('DNS check error:', error);
      updateDNSIndicator('a', 'error', 'Check failed');
      updateDNSIndicator('wildcard', 'error', 'Check failed');
      updateDNSIndicator('ssl', 'error', 'Check failed');
      document.getElementById('dns-registrar').textContent = 'Error';
    }
  }
  
  function updateDNSIndicator(type, status, text) {
    const indicator = document.getElementById(`dns-${type}-status`);
    const dot = indicator?.querySelector('.dns-dot');
    const value = document.getElementById(`dns-${type}-value`);
    
    if (dot) dot.className = 'dns-dot ' + status;
    if (value) value.textContent = text;
    dnsStatus[type] = status;
  }
  
  function onDomainChange(value) {
    currentDomain = value.trim().toLowerCase();
  }
  
  async function saveDomain() {
    const domain = document.getElementById('apex-domain').value.trim().toLowerCase();
    if (!domain) return;

    try {
      const response = await fetch('/api/network/domain', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ domain })
      });

      if (response.ok) {
        alert('‚úÖ Domain saved: ' + domain);
        checkDNS();
      } else {
        const data = await response.json();
        alert('‚ùå Failed: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      alert('‚ùå Error: ' + error.message);
    }
  }
  
  async function onConsoleChange(consoleId) {
    if (!consoleId || consoleId === currentTld) return;
    await setTldConsole(consoleId);
  }
  
  function copyServerIP() {
    const ip = document.getElementById('server-ip').textContent;
    navigator.clipboard.writeText(ip).then(() => {
      alert('üìã Copied: ' + ip);
    }).catch(() => {
      prompt('Copy this IP:', ip);
    });
  }

  // Subdomain Checker
  var subdomainResults = [];
  var COMMON_SUBDOMAINS = ['www', 'api', 'app', 'mail', 'cdn', 'static', 'assets', 'img', 'images', 'admin', 'dashboard', 'portal', 'dev', 'staging', 'test', 'beta'];
  
  // Console subdomain presets (editable in CN Console)
  // Source of truth: network-master.json ‚Üí routing.consoles[*].subdomains
  var DEFAULT_CONSOLE_PRESETS = {
    'quick-server': ['quick', 'quick-server'],
    'ai-console': ['ai'],
    'cn-console': ['cn'],
    'hive-console': ['hive'],
    'sunday-console': ['sunday'],
    'learnmappers-console': ['learnmappers'],
    'marketplace-console': ['marketplace'],
  };

  // Fallback until the network master config is loaded.
  var CONSOLE_SUBDOMAINS = [
    { name: 'quick', label: 'Quick Server', icon: '‚ö°', isConsole: true, consoleId: 'quick-server' },
    { name: 'cn', label: 'CN Console', icon: 'üß©', isConsole: true, consoleId: 'cn-console' },
    { name: 'ai', label: 'AI Console', icon: 'ü§ñ', isConsole: true, consoleId: 'ai-console' },
    { name: 'hive', label: 'Hive Console', icon: 'üêù', isConsole: true, consoleId: 'hive-console' },
    { name: 'sunday', label: 'Sunday Console', icon: 'üåû', isConsole: true, consoleId: 'sunday-console' },
    { name: 'learnmappers', label: 'LearnMappers', icon: 'üó∫Ô∏è', isConsole: true, consoleId: 'learnmappers-console' },
    { name: 'marketplace', label: 'Marketplace', icon: 'üõí', isConsole: true, consoleId: 'marketplace-console' },
  ];

  function normalizePresetLabels(value) {
    // return array of lowercased labels
    return String(value || '')
      .split(',')
      .map(s => s.trim().toLowerCase())
      .filter(Boolean)
      .filter(s => !s.includes('.') && /^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/.test(s));
  }

  function applyConsolePresetsFromNetwork(consoles) {
    if (!consoles) return;

    // Build console subdomains for DNS checking
    var next = [];
    var seen = new Set();
    var ids = Object.keys(consoles || {});

    for (var i = 0; i < ids.length; i++) {
      var id = ids[i];
      var c = consoles[id] || {};
      var icon = c.icon || 'üñ•Ô∏è';
      var label = c.name || id;

      var subs = [];
      if (Array.isArray(c.subdomains)) subs = c.subdomains.slice();
      else if (typeof c.subdomains === 'string') subs = normalizePresetLabels(c.subdomains);
      else subs = DEFAULT_CONSOLE_PRESETS[id] ? DEFAULT_CONSOLE_PRESETS[id].slice() : [];

      subs = subs.map(s => String(s || '').trim().toLowerCase()).filter(Boolean);

      for (var j = 0; j < subs.length; j++) {
        var name = subs[j];
        if (!name || seen.has(name)) continue;
        seen.add(name);
        next.push({ name: name, label: label, icon: icon, isConsole: true, consoleId: id });
      }
    }

    // If nothing configured, keep the current fallback.
    if (next.length) CONSOLE_SUBDOMAINS = next;

    // Render editor UI
    renderConsolePresets(consoles);
  }

  function renderConsolePresets(consoles) {
    var container = document.getElementById('console-presets');
    if (!container) return;

    var ids = Object.keys(consoles || {});
    if (!ids.length) {
      container.innerHTML = `
        <div class="subdomain-empty">
          <span>‚öôÔ∏è</span>
          <span>No consoles found in network master config</span>
        </div>
      `;
      return;
    }

    // Sort alphabetically but keep quick-server + cn-console first for convenience
    ids.sort(function(a, b) {
      var pin = function(id) {
        if (id === 'quick-server') return -2;
        if (id === 'cn-console') return -1;
        return 0;
      };
      var pa = pin(a);
      var pb = pin(b);
      if (pa !== pb) return pa - pb;
      return a.localeCompare(b);
    });

    container.innerHTML = ids.map(function(id) {
      var c = consoles[id] || {};
      var icon = c.icon || 'üñ•Ô∏è';
      var label = c.name || id;
      var subs = Array.isArray(c.subdomains) ? c.subdomains : (DEFAULT_CONSOLE_PRESETS[id] || []);
      var value = Array.isArray(subs) ? subs.join(', ') : String(subs || '');

      return `
        <div class="subdomain-card is-console">
          <div class="subdomain-icon">${icon}</div>
          <div class="subdomain-info">
            <div class="subdomain-name">
              ${label}
              <span class="subdomain-badge">Preset</span>
            </div>
            <div class="subdomain-url">${id}</div>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
              <input class="subdomain-input" id="preset-${id}" value="${escapeHtml(value)}" placeholder="e.g. quick, admin">
              <button class="sunday-btn secondary sm" onclick="saveConsolePreset('${id}')">Save</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function escapeHtml(str) {
    return String(str || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  async function saveConsolePreset(consoleId) {
    var input = document.getElementById('preset-' + consoleId);
    if (!input) return;

    var subdomains = normalizePresetLabels(input.value);

    try {
      var response = await fetch('/api/network/console-subdomains', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ consoleId: consoleId, subdomains: subdomains })
      });

      var data = await response.json();
      if (!data.success) throw new Error(data.error || 'Failed to save');

      // Update local cache and re-render
      if (tldDataCache && tldDataCache.consoles && tldDataCache.consoles[consoleId]) {
        tldDataCache.consoles[consoleId].subdomains = data.subdomains || subdomains;
      }

      applyConsolePresetsFromNetwork(tldDataCache ? tldDataCache.consoles : null);
      // Refresh DNS checks for console subdomains
      await loadConsoleSubdomains();
    } catch (err) {
      alert('‚ùå Failed to save presets: ' + (err.message || err));
    }
  }

  async function saveAllConsolePresets() {
    if (!tldDataCache || !tldDataCache.consoles) return;
    var ids = Object.keys(tldDataCache.consoles || {});
    for (var i = 0; i < ids.length; i++) {
      await saveConsolePreset(ids[i]);
      await new Promise(r => setTimeout(r, 50));
    }
  }
  
  // Auto-load console subdomains on page init
  async function loadConsoleSubdomains() {
    const domain = document.getElementById('apex-domain').value.trim();
    if (!domain || domain === 'localhost') return;
    
    // Add console subdomains with checking status
    subdomainResults = CONSOLE_SUBDOMAINS.map(sub => ({
      name: sub.name,
      label: sub.label,
      icon: sub.icon,
      isConsole: true,
      status: 'checking',
      type: null,
      value: 'Checking...'
    }));
    renderSubdomains();
    
    // Check each one
    for (const sub of CONSOLE_SUBDOMAINS) {
      await checkSubdomainDNS(sub.name);
      await new Promise(r => setTimeout(r, 50));
    }
  }

  async function checkSubdomain() {
    const input = document.getElementById('subdomain-input');
    const subdomain = input.value.trim().toLowerCase().replace(/\s+/g, '');
    if (!subdomain) return;
    
    input.value = '';
    
    // Don't add duplicates
    if (subdomainResults.find(s => s.name === subdomain)) {
      renderSubdomains();
      return;
    }
    
    // Add with checking status
    subdomainResults.unshift({ name: subdomain, status: 'checking', type: null, value: 'Checking...' });
    renderSubdomains();
    
    // Check the subdomain
    await checkSubdomainDNS(subdomain);
  }

  async function scanCommonSubdomains() {
    const domain = document.getElementById('apex-domain').value.trim();
    if (!domain) {
      alert('Please enter a domain first');
      return;
    }
    
    // Keep console subdomains, add common ones that aren't already there
    const existingNames = new Set(subdomainResults.map(s => s.name));
    const newSubdomains = COMMON_SUBDOMAINS.filter(name => !existingNames.has(name));
    
    // Add common subdomains with checking status
    for (const name of newSubdomains) {
      subdomainResults.push({
        name,
        status: 'checking',
        type: null,
        value: 'Checking...',
        isConsole: false
      });
    }
    renderSubdomains();
    
    // Check each new subdomain
    for (const subdomain of newSubdomains) {
      await checkSubdomainDNS(subdomain);
      // Small delay to not overwhelm
      await new Promise(r => setTimeout(r, 50));
    }
  }

  async function checkSubdomainDNS(subdomain) {
    const domain = document.getElementById('apex-domain').value.trim();
    if (!domain) return;
    
    const fullDomain = `${subdomain}.${domain}`;
    
    try {
      const response = await fetch(`/api/network/subdomain-check?subdomain=${encodeURIComponent(fullDomain)}`);
      if (response.ok) {
        const data = await response.json();
        
        // Update the result, preserving existing properties
        const idx = subdomainResults.findIndex(s => s.name === subdomain);
        if (idx !== -1) {
          const existing = subdomainResults[idx];
          subdomainResults[idx] = {
            ...existing, // Preserve label, icon, isConsole
            name: subdomain,
            fullDomain,
            status: data.resolved ? 'ok' : 'error',
            type: data.type || null,
            value: data.resolved ? (data.type === 'CNAME' ? data.target : data.ip) : 'Not configured',
            ip: data.ip,
            target: data.target,
            viaWildcard: data.viaWildcard
          };
        }
      }
    } catch (error) {
      const idx = subdomainResults.findIndex(s => s.name === subdomain);
      if (idx !== -1) {
        subdomainResults[idx].status = 'error';
        subdomainResults[idx].value = 'Check failed';
      }
    }
    
    renderSubdomains();
  }

  function renderSubdomains() {
    const container = document.getElementById('subdomain-results');
    const domain = document.getElementById('apex-domain').value.trim();
    
    if (subdomainResults.length === 0) {
      container.innerHTML = `
        <div class="subdomain-empty">
          <span>üîó</span>
          <span>Enter a subdomain above or click "Scan Common" to check multiple</span>
        </div>
      `;
      return;
    }
    
    // Sort: consoles first, then by name
    const sorted = [...subdomainResults].sort((a, b) => {
      if (a.isConsole && !b.isConsole) return -1;
      if (!a.isConsole && b.isConsole) return 1;
      return a.name.localeCompare(b.name);
    });
    
    container.innerHTML = sorted.map(s => `
      <div class="subdomain-card ${s.status === 'ok' ? 'resolved' : s.status === 'error' ? 'unresolved' : ''} ${s.isConsole ? 'is-console' : ''}">
        <div class="subdomain-dot ${s.status}"></div>
        ${s.icon ? `<div class="subdomain-icon">${s.icon}</div>` : ''}
        <div class="subdomain-info">
          <div class="subdomain-name">
            ${s.label || s.name}
            ${s.isConsole ? '<span class="subdomain-badge">Console</span>' : ''}
          </div>
          <div class="subdomain-url">${s.name}.${domain}</div>
          <div class="subdomain-value" title="${s.value}">${s.status === 'ok' ? '‚úì ' : s.status === 'error' ? '‚úó ' : ''}${s.value}${s.viaWildcard ? ' (via wildcard)' : ''}</div>
        </div>
        ${s.type ? `<div class="subdomain-type">${s.type}</div>` : ''}
      </div>
    `).join('');
  }

  function clearSubdomains() {
    subdomainResults = [];
    renderSubdomains();
  }

  function renderDashboard() {
    if (!networkData) return;

    // Health overview
    document.getElementById('healthyCount').textContent = networkData.health?.healthy || 0;
    document.getElementById('totalConsoles').textContent = networkData.consoles?.length || 0;
    document.getElementById('pm2Running').textContent = networkData.pm2?.filter(p => p.status === 'online').length || 0;
    document.getElementById('activePorts').textContent = networkData.ports?.length || 0;

    // TLD badge
    document.getElementById('tldBadge').textContent = currentTld || 'Unknown';

    // Console grid for TLD selection
    const consoleGrid = document.getElementById('consoleGrid');
    consoleGrid.innerHTML = networkData.consoles.map(c => `
      <div class="console-option ${c.id === currentTld ? 'selected' : ''}" 
           onclick="setTldConsole('${c.id}')"
           title="${c.healthy ? 'Healthy' : 'Not responding'}">
        <div class="icon">${c.icon}</div>
        <div class="name">${c.name}</div>
      </div>
    `).join('');

    // Console status grid
    const statusGrid = document.getElementById('consoleStatusGrid');
    statusGrid.innerHTML = networkData.consoles.map(c => `
      <div class="console-status-card">
        <div class="icon">${c.icon}</div>
        <div class="info">
          <div class="name">${c.name}</div>
          <div class="path">${c.isTLD ? '/ (TLD)' : c.path || ':' + c.port}</div>
        </div>
        <div class="status-dot ${c.healthy ? 'healthy' : 'unhealthy'}" 
             title="${c.healthy ? 'Healthy' : 'Not responding'}"></div>
      </div>
    `).join('');

    // PM2 table
    const pm2Body = document.getElementById('pm2TableBody');
    if (networkData.pm2?.length) {
      pm2Body.innerHTML = networkData.pm2.map(p => `
        <tr>
          <td style="padding:12px 16px;font-weight:600">${p.name}</td>
          <td style="padding:12px 16px">
            <span style="padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600;
              background:${p.status === 'online' ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)'};
              color:${p.status === 'online' ? 'var(--success)' : 'var(--error)'}">
              ${p.status}
            </span>
          </td>
          <td style="padding:12px 16px;font-family:monospace;font-size:12px">${p.pid || '-'}</td>
          <td style="padding:12px 16px">${formatBytes(p.memory)}</td>
          <td style="padding:12px 16px">${p.cpu?.toFixed(1) || 0}%</td>
          <td style="padding:12px 16px">${p.restarts || 0}</td>
          <td style="padding:12px 16px">
            <button class="sunday-btn ghost sm" onclick="restartPm2('${p.name}')">üîÑ</button>
          </td>
        </tr>
      `).join('');
    } else {
      pm2Body.innerHTML = '<tr><td colspan="7" style="padding:20px;text-align:center;color:var(--muted)">No PM2 processes found</td></tr>';
    }

    // Ports grid
    const portsGrid = document.getElementById('portsGrid');
    const importantPorts = [80, 443, 8001, 8888, 8890, 8902];
    portsGrid.innerHTML = networkData.ports
      .sort((a, b) => a.port - b.port)
      .map(p => `
        <div class="port-badge ${importantPorts.includes(p.port) ? 'important' : ''}">
          :${p.port} ${p.process ? `(${p.process})` : ''}
        </div>
      `).join('');

    // Traefik routes
    const traefikDiv = document.getElementById('traefikRoutes');
    if (networkData.traefik?.routers?.length) {
      traefikDiv.innerHTML = networkData.traefik.routers.map(r => `
        <div class="traefik-route">
          <div class="host">üåê ${r.host}</div>
          <div class="name">${r.name}</div>
        </div>
      `).join('');
    } else {
      traefikDiv.innerHTML = '<div style="color:var(--muted);padding:20px;text-align:center">No Traefik routes found</div>';
    }
  }

  async function setTldConsole(consoleId) {
    if (consoleId === currentTld) return;
    
    if (!confirm(`Set ${consoleId} as the TLD console?`)) return;
    
    try {
      const response = await fetch('/api/network/tld', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ console: consoleId })
      });
      
      const data = await response.json();
      if (!data.success) throw new Error(data.error);
      
      await refreshNetworkStatus();
      alert(`‚úÖ TLD console changed to ${consoleId}`);
    } catch (err) {
      alert(`‚ùå Failed: ${err.message}`);
    }
  }

  async function restartPm2(name) {
    if (!confirm(`Restart ${name}?`)) return;
    
    try {
      const response = await fetch(`/api/network-status/pm2/${name}/restart`, { method: 'POST' });
      const data = await response.json();
      
      if (!data.success) throw new Error(data.error);
      
      alert(`‚úÖ Restarted ${name}`);
      setTimeout(refreshNetworkStatus, 2000);
    } catch (err) {
      alert(`‚ùå Failed: ${err.message}`);
    }
  }

  function formatBytes(bytes) {
    if (!bytes) return '-';
    const mb = bytes / (1024 * 1024);
    return mb.toFixed(1) + ' MB';
  }

  // Load on page init - wait for DOM to be ready
  // Auto-refresh every 30 seconds (self-cancels once page is unmounted)
  // Keep timer id on window so fast away/back doesn't create duplicate intervals.
  var autoRefreshTimer = window.__cnNetworkAutoRefreshTimer || null;
  function startAutoRefresh() {
    if (autoRefreshTimer) {
      try { clearInterval(autoRefreshTimer); } catch {}
      autoRefreshTimer = null;
    }
    autoRefreshTimer = setInterval(() => {
      if (!isNetworkPageMounted()) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
        window.__cnNetworkAutoRefreshTimer = null;
        return;
      }
      refreshNetworkStatus().catch((err) => console.error('[Network] Auto-refresh failed:', err));
    }, 30000);
    window.__cnNetworkAutoRefreshTimer = autoRefreshTimer;
  }

  function initPage() {
    // Check if our elements exist
    if (!document.getElementById('healthyCount')) {
      // Elements not ready yet, try again
      requestAnimationFrame(initPage);
      return;
    }
    refreshNetworkStatus().catch((err) => console.error('[Network] Refresh failed:', err));
    startAutoRefresh();
  }
  
  // Start initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPage);
  } else {
    // DOM already ready, but use requestAnimationFrame to ensure elements are rendered
    requestAnimationFrame(initPage);
  }
  
  // Auto-refresh handled by startAutoRefresh()
</script>
